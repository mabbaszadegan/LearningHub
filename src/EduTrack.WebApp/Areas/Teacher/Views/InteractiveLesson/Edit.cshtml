@model EduTrack.Application.Features.InteractiveLesson.DTOs.InteractiveLessonDto

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ویرایشگر درس تعاملی: @Model.Title</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-success" onclick="addInteractiveQuestion()">
                            <i class="fas fa-question"></i> اضافه کردن سوال
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- ویرایشگر درس تعاملی -->
                    <div id="interactive-lesson-editor">
                        <!-- محتوای آموزشی موجود -->
                        <div class="row">
                            <div class="col-md-6">
                                <h5>محتوای آموزشی موجود</h5>
                                <div id="available-content-list" class="list-group">
                                    <!-- محتوای موجود اینجا بارگذاری می‌شود -->
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h5>محتوای درس تعاملی</h5>
                                <div id="lesson-content-list" class="list-group">
                                    @foreach (var item in Model.ContentItems.OrderBy(x => x.Order))
                                    {
                                        <div class="list-group-item" data-item-id="@item.Id">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h6 class="mb-1">
                                                    @if (item.EducationalContent != null)
                                                    {
                                                        <i class="fas fa-file-alt"></i> @item.EducationalContent.Title
                                                    }
                                                    else if (item.InteractiveQuestion != null)
                                                    {
                                                        <i class="fas fa-question"></i> @item.InteractiveQuestion.QuestionText
                                                    }
                                                </h6>
                                                <div>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeContentFromLesson(@item.Id)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <p class="mb-1">
                                                @if (item.EducationalContent != null)
                                                {
                                                    @item.EducationalContent.Description
                                                }
                                                else if (item.InteractiveQuestion != null)
                                                {
                                                    @item.InteractiveQuestion.Description
                                                }
                                            </p>
                                            <small>ترتیب: @item.Order</small>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal برای اضافه کردن سوال -->
<div class="modal fade" id="addQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">اضافه کردن سوال تعاملی</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addQuestionForm">
                    <div class="form-group">
                        <label>نوع سوال</label>
                        <select id="questionType" class="form-control" onchange="toggleQuestionFields()">
                            <option value="1">چند گزینه‌ای</option>
                            <option value="2">چند گزینه‌ای (چند پاسخ)</option>
                            <option value="3">تایپ متن</option>
                            <option value="4">انتخاب تصویر</option>
                            <option value="5">درست/نادرست</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>متن سوال</label>
                        <textarea id="questionText" class="form-control" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>توضیحات</label>
                        <textarea id="questionDescription" class="form-control" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>نمره</label>
                        <input type="number" id="questionPoints" class="form-control" value="1" min="1" />
                    </div>
                    
                    <!-- گزینه‌های سوال -->
                    <div id="questionChoices" style="display: none;">
                        <label>گزینه‌ها</label>
                        <div id="choicesList">
                            <!-- گزینه‌ها اینجا اضافه می‌شوند -->
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addChoice()">
                            <i class="fas fa-plus"></i> اضافه کردن گزینه
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>پاسخ صحیح</label>
                        <input type="text" id="correctAnswer" class="form-control" />
                    </div>
                    
                    <div class="form-group">
                        <label>ترتیب</label>
                        <input type="number" id="questionOrder" class="form-control" min="0" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">انصراف</button>
                <button type="button" class="btn btn-primary" onclick="saveInteractiveQuestion()">ذخیره</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentLessonId = @Model.Id;

// بارگذاری محتوای موجود
$(document).ready(function() {
    loadAvailableContent();
});

function loadAvailableContent() {
    $.ajax({
        url: '@Url.Action("GetAvailableContent", "InteractiveLesson")',
        type: 'GET',
        data: { courseId: @Model.CourseId },
        success: function(response) {
            if (response.success) {
                displayAvailableContent(response.data);
            } else {
                console.error('خطا در بارگذاری محتوا:', response.error);
            }
        },
        error: function() {
            console.error('خطا در بارگذاری محتوا');
        }
    });
}

function displayAvailableContent(contentList) {
    const container = $('#available-content-list');
    container.empty();
    
    contentList.forEach(function(content) {
        const contentHtml = `
            <div class="list-group-item" data-content-id="${content.id}">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${content.title}</h6>
                    <small>${getContentTypeText(content.type)}</small>
                </div>
                <p class="mb-1">${content.description || ''}</p>
                <button type="button" class="btn btn-sm btn-primary" onclick="addContentToLesson(${content.id})">
                    <i class="fas fa-plus"></i> اضافه کردن
                </button>
            </div>
        `;
        container.append(contentHtml);
    });
}

function getContentTypeText(type) {
    const types = {
        1: 'متن',
        2: 'تصویر',
        3: 'ویدیو',
        4: 'صدا',
        5: 'PDF',
        6: 'لینک خارجی',
        7: 'فایل'
    };
    return types[type] || 'نامشخص';
}

function addContentToLesson(contentId) {
    const order = $('#lesson-content-list .list-group-item').length;
    
    $.ajax({
        url: '@Url.Action("AddContent", "InteractiveLesson")',
        type: 'POST',
        data: {
            interactiveLessonId: currentLessonId,
            educationalContentId: contentId,
            order: order
        },
        success: function(response) {
            if (response.success) {
                location.reload(); // بارگذاری مجدد صفحه
            } else {
                alert('خطا: ' + response.error);
            }
        },
        error: function() {
            alert('خطا در اضافه کردن محتوا');
        }
    });
}

function removeContentFromLesson(itemId) {
    if (confirm('آیا مطمئن هستید که می‌خواهید این محتوا را حذف کنید؟')) {
        $.ajax({
            url: '@Url.Action("RemoveContent", "InteractiveLesson")',
            type: 'POST',
            data: { contentItemId: itemId },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('خطا: ' + response.error);
                }
            },
            error: function() {
                alert('خطا در حذف محتوا');
            }
        });
    }
}

function addInteractiveQuestion() {
    $('#addQuestionModal').modal('show');
}

function toggleQuestionFields() {
    const questionType = $('#questionType').val();
    
    if (questionType === '1' || questionType === '2') { // چند گزینه‌ای
        $('#questionChoices').show();
    } else {
        $('#questionChoices').hide();
    }
}

function addChoice() {
    const choiceHtml = `
        <div class="choice-item mb-2">
            <div class="row">
                <div class="col-md-8">
                    <input type="text" class="form-control choice-text" placeholder="متن گزینه" />
                </div>
                <div class="col-md-2">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input choice-correct" />
                        <label class="form-check-label">صحیح</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeChoice(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    $('#choicesList').append(choiceHtml);
}

function removeChoice(button) {
    $(button).closest('.choice-item').remove();
}

function saveInteractiveQuestion() {
    const questionData = {
        interactiveLessonId: currentLessonId,
        questionText: $('#questionText').val(),
        description: $('#questionDescription').val(),
        type: $('#questionType').val(),
        correctAnswer: $('#correctAnswer').val(),
        points: $('#questionPoints').val(),
        order: $('#questionOrder').val()
    };
    
    // جمع‌آوری گزینه‌ها
    if (questionData.type === '1' || questionData.type === '2') {
        questionData.choices = [];
        $('.choice-item').each(function() {
            const text = $(this).find('.choice-text').val();
            const isCorrect = $(this).find('.choice-correct').is(':checked');
            if (text) {
                questionData.choices.push({
                    text: text,
                    isCorrect: isCorrect
                });
            }
        });
    }
    
    $.ajax({
        url: '@Url.Action("AddQuestion", "InteractiveLesson")',
        type: 'POST',
        data: questionData,
        success: function(response) {
            if (response.success) {
                $('#addQuestionModal').modal('hide');
                location.reload();
            } else {
                alert('خطا: ' + response.error);
            }
        },
        error: function() {
            alert('خطا در ذخیره سوال');
        }
    });
}

// Event listeners
$('#questionType').change(toggleQuestionFields);
</script>
