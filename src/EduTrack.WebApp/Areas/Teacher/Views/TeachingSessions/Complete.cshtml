@using EduTrack.WebApp.Areas.Teacher.Views.Shared.Components.PageNavigation
@model EduTrack.Application.Common.Models.SessionCompletionDataDto
@{
    ViewData["Title"] = "تکمیل گزارش جلسه آموزشی";
    var courseTitle = ViewBag.CourseTitle as string;

    // Prepare navigation actions
    var navigationActions = new List<NavigationAction>
    {
        new NavigationAction
        {
            Text = "مشاهده جزئیات",
            Url = Url.Action("Details", new { id = Model.SessionId }) ?? "#",
            CssClass = "btn-action-secondary",
            Icon = "fas fa-eye"
        },
        new NavigationAction
        {
            Text = "بازگشت",
            Url = Url.Action("Index", new { planId = Model.TeachingPlanId }) ?? "#",
            CssClass = "btn-action-primary",
            Icon = "fas fa-arrow-right"
        }
    };

    // Prepare breadcrumb items
    var breadcrumbItems = new List<BreadcrumbItem>
    {
        new BreadcrumbItem
        {
            Text = "دوره‌ها",
            Url = Url.Action("Index", "Courses"),
            Icon = "fas fa-chevron-right"
        },
        new BreadcrumbItem
        {
            Text = courseTitle ?? "دوره",
            Url = Url.Action("Index", "TeachingPlan", new { courseId = ViewBag.CourseId })
        },
        new BreadcrumbItem
        {
            Text = "جلسات آموزشی",
            Url = Url.Action("Index", new { planId = Model.TeachingPlanId })
        },
        new BreadcrumbItem
        {
            Text = Model.SessionTitle,
            IsActive = true
        }
    };

}

@await Component.InvokeAsync("PageNavigation", new {
    title = "تکمیل گزارش جلسه آموزشی",
    breadcrumbItems = breadcrumbItems,
    actions = navigationActions
})

<!-- Session Overview Cards -->
<div class="session-overview mb-4">
    <div class="overview-grid">
        <div class="overview-card">
            <div class="overview-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="overview-content">
                <h3 class="overview-title">تاریخ جلسه</h3>
                <p class="overview-value">@Model.SessionDate.ToString("yyyy/MM/dd")</p>
            </div>
        </div>
        <div class="overview-card">
            <div class="overview-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="overview-content">
                <h3 class="overview-title">زمان جلسه</h3>
                <p class="overview-value">@Model.SessionDate.ToString("HH:mm")</p>
            </div>
        </div>
        <div class="overview-card">
            <div class="overview-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="overview-content">
                <h3 class="overview-title">تعداد گروه‌ها</h3>
                <p class="overview-value">@Model.Groups.Count گروه</p>
            </div>
        </div>
        <div class="overview-card">
            <div class="overview-icon">
                <i class="fas fa-clipboard-check"></i>
            </div>
            <div class="overview-content">
                <h3 class="overview-title">وضعیت برنامه‌ریزی</h3>
                <p class="overview-value">
                    @if (Model.HasPlan)
                    {
                        <span class="status-badge status-planned">
                            <i class="fas fa-check-circle"></i> برنامه‌ریزی شده
                        </span>
                    }
                    else
                    {
                        <span class="status-badge status-unplanned">
                            <i class="fas fa-exclamation-circle"></i> بدون برنامه‌ریزی
                        </span>
                    }
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Step-by-Step Completion Form -->
<div class="step-completion-container">
    <!-- Step Progress Indicator -->
    <div class="step-progress">
        <div class="step-progress-bar">
            <div class="step-progress-fill" id="stepProgressFill"></div>
        </div>
        <div class="step-indicators" id="stepIndicators">
            <!-- Steps will be populated by JavaScript -->
        </div>
    </div>

    <!-- Step Content -->
    <div class="step-content">
        <!-- Step 1: Attendance -->
        <div class="step-panel" id="step-1" data-step="1">
            <div class="step-header">
                <h3 class="step-title">
                    <i class="fas fa-user-check"></i>
                    مرحله ۱: حضور و غیاب
                </h3>
                <p class="step-description">ثبت حضور و غیاب دانش‌آموزان هر گروه</p>
            </div>

            <div class="step-body">
                <div class="attendance-tabs-container">
                    <div class="attendance-tabs-nav" id="attendanceTabsNav">
                        <!-- Tab navigation will be populated by JavaScript -->
                    </div>
                    <div class="attendance-tabs-content" id="attendanceTabsContent">
                        <!-- Tab content will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="step-actions">
                <button type="button" class="btn-save-step" data-step="1">
                    <i class="fas fa-save"></i>
                    ذخیره حضور و غیاب
                </button>
                <button type="button" class="btn-next-step" data-next-step="2">
                    <i class="fas fa-arrow-left"></i>
                    مرحله بعد
                </button>
            </div>
        </div>

        <!-- Step 2: Feedback -->
        <div class="step-panel" id="step-2" data-step="2" style="display: none;">
            <div class="step-header">
                <h3 class="step-title">
                    <i class="fas fa-comment-alt"></i>
                    مرحله ۲: بازخورد گروه‌ها
                </h3>
                <p class="step-description">ارائه بازخورد برای هر گروه</p>
            </div>

            <div class="step-body">
                <div class="feedback-tabs-container">
                    <div class="feedback-tabs-nav" id="feedbackTabsNav">
                        <!-- Feedback tabs will be populated by JavaScript -->
                    </div>
                    <div class="feedback-tabs-content" id="feedbackTabsContent">
                        <!-- Feedback content will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="step-actions">
                <button type="button" class="btn-prev-step" data-prev-step="1">
                    <i class="fas fa-arrow-right"></i>
                    مرحله قبل
                </button>
                <button type="button" class="btn-save-step" data-step="2">
                    <i class="fas fa-save"></i>
                    ذخیره بازخورد
                </button>
                <button type="button" class="btn-next-step" data-next-step="3">
                    <i class="fas fa-arrow-left"></i>
                    مرحله بعد
                </button>
            </div>
        </div>

        <!-- Step 3: Topic Coverage -->
        <div class="step-panel" id="step-3" data-step="3" style="display: none;">
            <div class="step-header">
                <h3 class="step-title">
                    <i class="fas fa-check-square"></i>
                    مرحله ۳: پوشش موضوعات
                </h3>
                <p class="step-description">ثبت موضوعات پوشش داده شده برای هر گروه</p>
            </div>

            <div class="step-body">
                <div class="group-topic-coverage-container" id="topicCoverageContainer">
                    <!-- Topic coverage forms will be populated by JavaScript -->
                </div>
            </div>

            <div class="step-actions">
                <button type="button" class="btn-prev-step" data-prev-step="2">
                    <i class="fas fa-arrow-right"></i>
                    مرحله قبل
                </button>
                <button type="button" class="btn-save-step" data-step="3">
                    <i class="fas fa-save"></i>
                    ذخیره پوشش موضوعات
                </button>
                <button type="button" class="btn-complete-session" id="completeSession">
                    <i class="fas fa-check-circle"></i>
                    تکمیل گزارش
                </button>
            </div>
        </div>
    </div>

    <!-- Completion Summary -->
    <div class="completion-summary" id="completionSummary" style="display: none;">
        <div class="summary-header">
            <h3 class="summary-title">
                <i class="fas fa-check-circle text-success"></i>
                گزارش جلسه با موفقیت تکمیل شد
            </h3>
            <p class="summary-description">تمام مراحل تکمیل گزارش جلسه آموزشی انجام شد.</p>
        </div>

        <div class="summary-actions">
            <a asp-action="Details" asp-route-id="@Model.SessionId" class="btn-view-report">
                <i class="fas fa-eye"></i>
                مشاهده گزارش
            </a>
            <a asp-action="Index" asp-route-planId="@Model.TeachingPlanId" class="btn-back-to-sessions">
                <i class="fas fa-list"></i>
                بازگشت به جلسات
            </a>
        </div>
    </div>
</div>

<!-- Hidden form for data -->
<form id="hiddenForm" style="display: none;">
    <input type="hidden" id="sessionId" value="@Model.SessionId" />
    <input type="hidden" id="hasPlan" value="@Model.HasPlan.ToString().ToLower()" />
    <input type="hidden" id="groupsData" value="@ViewBag.GroupsJson" />
    <input type="hidden" id="subTopicsData" value="@ViewBag.AvailableSubTopicsJson" />
    <input type="hidden" id="lessonsData" value="@ViewBag.AvailableLessonsJson" />
    <input type="hidden" id="plannedItemsData" value="@ViewBag.PlannedItemsJson" />
</form>

@section Styles {
    <link rel="stylesheet" href="~/css/areas/teacher/teaching-sessions/details.css" />
    <link rel="stylesheet" href="~/css/areas/teacher/teaching-sessions/complete.css" />
    <link rel="stylesheet" href="~/css/areas/teacher/teaching-sessions/step-completion.css" />
}

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="~/js/areas/teacher/teaching-sessions/complete.js"></script>
}