@using EduTrack.Application.Common.Models.TeachingSessions
@using EduTrack.WebApp.Areas.Teacher.Views.Shared.Components.PageNavigation
@model TeachingSessionReportDto
@{
    ViewData["Title"] = "جزئیات جلسه آموزشی";
    var courseTitle = ViewBag.CourseTitle as string;
    
    // Prepare navigation actions
    var navigationActions = new List<NavigationAction>
    {
        new NavigationAction
        {
            Text = "تکمیل گزارش",
            Url = Url.Action("Complete", new { id = Model.Id }) ?? "#",
            CssClass = "btn-action-success",
            Icon = "fas fa-check-circle"
        },
        new NavigationAction
        {
            Text = "ویرایش",
            Url = Url.Action("Edit", new { id = Model.Id }) ?? "#",
            CssClass = "btn-action-secondary",
            Icon = "fas fa-edit"
        },
        new NavigationAction
        {
            Text = "بازگشت",
            Url = Url.Action("Index", new { planId = Model.TeachingPlanId }) ?? "#",
            CssClass = "btn-action-primary",
            Icon = "fas fa-arrow-right"
        }
    };
    
    // Prepare breadcrumb items
    var breadcrumbItems = new List<BreadcrumbItem>
    {
        new BreadcrumbItem
        {
            Text = "دوره‌ها",
            Url = Url.Action("Index", "Courses"),
            Icon = "fas fa-chevron-right"
        },
        new BreadcrumbItem
        {
            Text = courseTitle ?? "دوره",
            Url = Url.Action("Index", "TeachingPlan", new { courseId = ViewBag.CourseId })
        },
        new BreadcrumbItem
        {
            Text = "جلسات آموزشی",
            Url = Url.Action("Index", new { planId = Model.TeachingPlanId })
        },
        new BreadcrumbItem
        {
            Text = Model.Title ?? "جلسه بدون عنوان",
            IsActive = true
        }
    };
}

@await Component.InvokeAsync("PageNavigation", new { 
    title = "جزئیات جلسه آموزشی", 
    breadcrumbItems = breadcrumbItems, 
    actions = navigationActions 
})

<!-- Session Overview Cards -->
<div class="session-overview mb-4">
    <div class="overview-grid">
        <div class="overview-card">
            <div class="overview-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="overview-content">
                <h3>تاریخ جلسه</h3>
                <p class="overview-date">@Model.SessionDate.ToString("dd MMM yyyy")</p>
                <p class="overview-time">@Model.SessionDate.ToString("HH:mm")</p>
            </div>
        </div>

        <div class="overview-card">
            <div class="overview-icon">
                <i class="fas fa-video"></i>
            </div>
            <div class="overview-content">
                <h3>نوع جلسه</h3>
                <span class="mode-badge bg-@(Model.Mode == EduTrack.Domain.Enums.SessionMode.InPerson ? "primary" : Model.Mode == EduTrack.Domain.Enums.SessionMode.Online ? "success" : "warning")">
                    @(Model.Mode == EduTrack.Domain.Enums.SessionMode.InPerson ? "حضوری" : Model.Mode == EduTrack.Domain.Enums.SessionMode.Online ? "آنلاین" : "ترکیبی")
                </span>
            </div>
        </div>

        <div class="overview-card">
            <div class="overview-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="overview-content">
                <h3>حضور و غیاب</h3>
                <div class="attendance-stats">
                    <span class="stat-present">@Model.PresentCount حاضر</span>
                    <span class="stat-absent">@Model.AbsentCount غایب</span>
                </div>
                <p class="stat-total">@Model.AttendanceCount نفر کل</p>
            </div>
        </div>

        <div class="overview-card">
            <div class="overview-icon">
                <i class="fas fa-user-tie"></i>
            </div>
            <div class="overview-content">
                <h3>ایجاد شده توسط</h3>
                <p class="overview-teacher">@Model.CreatedByTeacherName</p>
                <p class="overview-date">@Model.CreatedAt.ToString("dd MMM yyyy")</p>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.Location))
{
    <div class="location-info mb-4">
        <div class="location-card">
            <i class="fas fa-map-marker-alt"></i>
            <div>
                <h4>مکان برگزاری</h4>
                <p>@Model.Location</p>
            </div>
        </div>
    </div>
}

<!-- Session Content Tabs -->
<div class="session-tabs-container">
    <div class="tabs-header">
        <button class="tab-btn active" data-tab="summary">
            <i class="fas fa-info-circle"></i>
            <span>خلاصه جلسه</span>
        </button>
        <button class="tab-btn" data-tab="attendance">
            <i class="fas fa-users"></i>
            <span>حضور و غیاب</span>
        </button>
        <button class="tab-btn" data-tab="assignments">
            <i class="fas fa-tasks"></i>
            <span>ایجاد تکلیف</span>
        </button>
    </div>

    <div class="tabs-content">
        <!-- Summary Tab -->
        <div class="tab-panel active" id="summary">
            <div class="content-grid">
                <div class="content-card">
                    <div class="card-header">
                        <h4>
                            <i class="fas fa-list-ul"></i>
                            موضوعات تدریس شده
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="json-content">
                            <pre>@Model.TopicsJson</pre>
                        </div>
                    </div>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h4>
                            <i class="fas fa-chart-bar"></i>
                            آمار جلسه
                        </h4>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(Model.StatsJson))
                        {
                            <div class="json-content">
                                <pre>@Model.StatsJson</pre>
                            </div>
                        }
                        else
                        {
                            <div class="empty-content">
                                <i class="fas fa-chart-line"></i>
                                <p>آمار جلسه ثبت نشده</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Model.Notes))
            {
                <div class="content-card full-width">
                    <div class="card-header">
                        <h4>
                            <i class="fas fa-sticky-note"></i>
                            یادداشت‌های جلسه
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="notes-content">
                            <p>@Model.Notes</p>
                        </div>
                    </div>
                </div>
            }

            @if (!string.IsNullOrEmpty(Model.AttachmentsJson))
            {
                <div class="content-card full-width">
                    <div class="card-header">
                        <h4>
                            <i class="fas fa-paperclip"></i>
                            ضمائم جلسه
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="json-content">
                            <pre>@Model.AttachmentsJson</pre>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Attendance Tab -->
        <div class="tab-panel" id="attendance">
            <div class="attendance-container">
                @if (Model.Attendance.Any())
                {
                    <div class="attendance-header">
                        <h4>
                            <i class="fas fa-users"></i>
                            لیست حضور و غیاب
                        </h4>
                        <div class="attendance-summary">
                            <span class="summary-item">
                                <i class="fas fa-check-circle text-success"></i>
                                <span>@Model.PresentCount حاضر</span>
                            </span>
                            <span class="summary-item">
                                <i class="fas fa-times-circle text-danger"></i>
                                <span>@Model.AbsentCount غایب</span>
                            </span>
                            <span class="summary-item">
                                <i class="fas fa-users"></i>
                                <span>@Model.Attendance.Count کل دانش‌آموزان</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="attendance-grid">
                        @foreach (var attendance in Model.Attendance)
                        {
                            var hasRecord = attendance.Id > 0;
                            <div class="student-card @(hasRecord ? "has-record" : "")" data-student-id="@attendance.StudentId" data-attendance-id="@attendance.Id">
                                <div class="card-header">
                                    <div class="student-avatar">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="student-info">
                                        <h5>@attendance.StudentName</h5>
                                        <div class="completion-indicator">
                                            @if (hasRecord)
                                            {
                                                <i class="fas fa-check-circle text-success"></i>
                                                <span class="text-success">ثبت شده</span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-clock text-muted"></i>
                                                <span class="text-muted">ثبت نشده</span>
                                            }
                                        </div>
                                    </div>
                                    <div class="card-actions">
                                        <button class="btn-edit-attendance" title="ویرایش حضور و غیاب">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="card-content">
                                    <div class="attendance-status">
                                        <label>وضعیت:</label>
                                        @if (hasRecord)
                                        {
                                            <span class="status-badge bg-@(attendance.Status == EduTrack.Domain.Enums.AttendanceStatus.Present ? "success" : 
                                                                            attendance.Status == EduTrack.Domain.Enums.AttendanceStatus.Absent ? "danger" : 
                                                                            attendance.Status == EduTrack.Domain.Enums.AttendanceStatus.Late ? "warning" : "info")">
                                                @(attendance.Status == EduTrack.Domain.Enums.AttendanceStatus.Present ? "حاضر" : 
                                                  attendance.Status == EduTrack.Domain.Enums.AttendanceStatus.Absent ? "غایب" : 
                                                  attendance.Status == EduTrack.Domain.Enums.AttendanceStatus.Late ? "تأخیر" : "معذور")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="status-badge bg-secondary">ثبت نشده</span>
                                        }
                                    </div>
                                    
                                    <div class="participation-score">
                                        <label>نمره مشارکت:</label>
                                        @if (hasRecord && attendance.ParticipationScore.HasValue)
                                        {
                                            <span class="score-value">@attendance.ParticipationScore.Value.ToString("F1")</span>
                                        }
                                        else
                                        {
                                            <span class="no-value">@(hasRecord ? "-" : "ثبت نشده")</span>
                                        }
                                    </div>
                                    
                                    <div class="attendance-comment">
                                        <label>یادداشت:</label>
                                        @if (hasRecord && !string.IsNullOrEmpty(attendance.Comment))
                                        {
                                            <p class="comment-text">@attendance.Comment</p>
                                        }
                                        else
                                        {
                                            <span class="no-value">@(hasRecord ? "-" : "ثبت نشده")</span>
                                        }
                                    </div>
                                </div>
                                
                                <!-- Edit Form (Hidden by default) -->
                                <div class="edit-form" style="display: none;">
                                    <form class="attendance-edit-form" data-student-id="@attendance.StudentId" data-attendance-id="@attendance.Id">
                                        <div class="form-group">
                                            <label>وضعیت حضور:</label>
                                            <select name="status" class="form-control">
                                                <option value="0" selected="@(attendance.Status == EduTrack.Domain.Enums.AttendanceStatus.Absent)">غایب</option>
                                                <option value="1" selected="@(attendance.Status == EduTrack.Domain.Enums.AttendanceStatus.Present)">حاضر</option>
                                                <option value="2" selected="@(attendance.Status == EduTrack.Domain.Enums.AttendanceStatus.Late)">تأخیر</option>
                                                <option value="3" selected="@(attendance.Status == EduTrack.Domain.Enums.AttendanceStatus.Excused)">معذور</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label>نمره مشارکت:</label>
                                            <input type="number" name="participationScore" class="form-control" 
                                                   value="@(attendance.ParticipationScore?.ToString("F1") ?? "")" 
                                                   min="0" max="10" step="0.1" placeholder="@(hasRecord ? "نمره فعلی: " + (attendance.ParticipationScore?.ToString("F1") ?? "-") : "0.0")">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label>یادداشت:</label>
                                            <textarea name="comment" class="form-control" rows="2" 
                                                      placeholder="@(hasRecord ? "یادداشت فعلی: " + (attendance.Comment ?? "-") : "یادداشت اختیاری...")">@attendance.Comment</textarea>
                                        </div>
                                        
                                        <div class="form-actions">
                                            <button type="submit" class="btn-save">
                                                <i class="fas fa-save"></i>
                                                ذخیره
                                            </button>
                                            <button type="button" class="btn-cancel">
                                                <i class="fas fa-times"></i>
                                                انصراف
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>هیچ دانش‌آموزی یافت نشد</h3>
                        <p>ابتدا باید گروه‌های دانش‌آموزی برای این پلن آموزشی تعریف شوند</p>
                    </div>
                }
            </div>
        </div>

        <!-- Assignments Tab -->
        <div class="tab-panel" id="assignments">
            <div class="assignments-container">
                <div class="assignment-card">
                    <div class="assignment-header">
                        <h4>
                            <i class="fas fa-tasks"></i>
                            ایجاد تکلیف از جلسه
                        </h4>
                        <p>بر اساس این جلسه آموزشی، تکالیف هدفمند برای دانش‌آموزان یا گروه‌های خاص ایجاد کنید</p>
                    </div>
                    <div class="assignment-actions">
                        <a asp-action="CreateScheduleItemFromReport" asp-route-reportId="@Model.Id" class="btn-create-assignment">
                            <i class="fas fa-plus"></i>
                            <span>ایجاد تکلیف جدید</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/areas/teacher/teaching-sessions/details.css" />
    <style>
       
    </style>
}

@section Scripts {
    <script>
        // Set session ID for JavaScript
        document.body.setAttribute('data-session-id', '@Model.Id');
    </script>
    <script src="~/js/areas/teacher/teaching-sessions/details.js"></script>
}
