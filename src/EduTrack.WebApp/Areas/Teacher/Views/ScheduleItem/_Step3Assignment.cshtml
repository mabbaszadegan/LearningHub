@model EduTrack.Application.Common.Models.ScheduleItems.CreateScheduleItemRequest
@{
    var isCourseScope = ViewData["IsCourseScope"] as bool? ?? false;
}

<div class="form-step" data-step="assignment" data-step-order="3">
    <div class="step-header">
        <div class="step-icon">
            <i class="fas fa-users"></i>
        </div>
        <div class="step-info">
            <h3 class="step-title">تخصیص و گروه‌بندی</h3>
            <p class="step-description">گروه‌های هدف و زیرمباحث مرتبط را انتخاب کنید</p>
        </div>
    </div>
    
    <div class="step-content">
        @if (!isCourseScope)
        {
            <!-- Group Selection Section -->
            <div class="assignment-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="section-info">
                        <h4 class="section-title">تخصیص گروه‌ها</h4>
                        <p class="section-description">گروه‌های هدف را انتخاب کنید</p>
                    </div>
                </div>
                
                <div class="badge-selection-container">
                    <div class="selection-hint">
                        <i class="fas fa-info-circle"></i>
                        <span>اگر گروهی انتخاب نکنید، آیتم برای همه گروه‌ها خواهد بود</span>
                    </div>
                    <div class="badge-grid" id="groupBadgeGrid">
                        <!-- Groups will be loaded dynamically as badges -->
                    </div>
                    <!-- Student Selection Container - Hidden by default -->
                    <div class="student-selection-container" id="studentSelectionContainer" style="display: none;">
                        <div class="student-list-container" id="studentListContainer">
                            <div class="student-list-header">
                                <div class="student-count" id="studentCount">0 دانش‌آموز</div>
                                <div class="student-actions">
                                    <button type="button" class="btn-select-all" id="selectAllStudents">
                                        <i class="fas fa-check-double"></i>
                                        انتخاب همه
                                    </button>
                                    <button type="button" class="btn-clear-all" id="clearAllStudents">
                                        <i class="fas fa-times"></i>
                                        پاک کردن همه
                                    </button>
                                </div>
                            </div>
                            
                            <div class="student-grid" id="studentGrid">
                                <!-- Students will be loaded dynamically -->
                            </div>
                            
                            <div class="selected-students-summary" id="selectedStudentsSummary">
                                <div class="summary-text">
                                    <span id="selectedStudentsText">هیچ دانش‌آموزی انتخاب نشده - برای همه دانش‌آموزان گروه</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="assignment-section">
                <div class="selection-hint">
                    <i class="fas fa-user-graduate"></i>
                    <span>این آیتم به صورت عمومی برای تمام دانشجویان ثبت‌نام شده در این دوره منتشر می‌شود.</span>
                </div>
            </div>
        }
        
        <!-- SubChapter Selection Section -->
        <div class="assignment-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-list-alt"></i>
                </div>
                <div class="section-info">
                    <h4 class="section-title">زیرمباحث مرتبط</h4>
                    <p class="section-description">@(!isCourseScope ? "زیرمباحث مرتبط را انتخاب کنید" : "زیرمباحث دوره را انتخاب کنید تا همه دانشجویان دوره دسترسی داشته باشند")</p>
                </div>
                <div class="required-badge">
                    <span>اجباری</span>
                </div>
            </div>
            
            <div class="chapter-hierarchy-container">
                <div class="selection-hint">
                    <i class="fas fa-info-circle"></i>
                    <span>انتخاب حداقل یک زیرمبحث اجباری است</span>
                </div>
                <div class="chapter-list" id="chapterList">
                    <!-- Chapters and subchapters will be loaded dynamically -->
                </div>
                <div class="selected-summary" id="subChapterSelectionSummary">
                    <span class="summary-text">هیچ زیرمبحثی انتخاب نشده</span>
                </div>
                <div class="validation-message" id="subChapterValidationError" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>انتخاب حداقل یک زیرمبحث اجباری است</span>
                </div>
            </div>
        </div>
        
        <!-- Assignment Preview Section -->
        <div class="assignment-preview-modern" id="assignmentPreview">
            <div class="preview-header-modern">
                <div class="preview-icon">
                    <i class="fas fa-eye"></i>
                </div>
                <div class="preview-title">
                    <h5>پیش‌نمایش تخصیص</h5>
                    <p>خلاصه تنظیمات انتخاب شده</p>
                </div>
            </div>
            <div class="preview-content-modern">
                @if (!isCourseScope)
                {
                <div class="preview-item">
                        <div class="preview-item-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="preview-item-content">
                            <div class="preview-item-label">گروه‌های هدف</div>
                            <div class="preview-item-value" id="targetGroups">همه گروه‌ها</div>
                        </div>
                    </div>
                }
                <div class="preview-item">
                    <div class="preview-item-icon">
                        <i class="fas fa-list-alt"></i>
                    </div>
                    <div class="preview-item-content">
                        <div class="preview-item-label">زیرمباحث مرتبط</div>
                        <div class="preview-item-value" id="relatedSubChapters">انتخاب نشده</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
