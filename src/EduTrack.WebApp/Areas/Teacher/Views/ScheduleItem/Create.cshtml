@model EduTrack.Application.Common.Models.ScheduleItems.CreateScheduleItemRequest
@{
    ViewData["Title"] = "ایجاد آیتم آموزشی جدید";
    var teachingPlanId = ViewBag.TeachingPlanId as int? ?? 0;
    var teachingPlanTitle = ViewBag.TeachingPlanTitle as string ?? "برنامه آموزشی";
    var courseTitle = ViewBag.CourseTitle as string ?? "دوره";
    var courseId = ViewBag.CourseId as int? ?? 0;
    var scheduleItemTypes = ViewBag.ScheduleItemTypes as List<object> ?? new List<object>();
}

<!-- Modern Page Header -->
<div class="modern-page-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <nav class="breadcrumb-nav">
                    <a asp-controller="Courses" asp-action="Index" class="breadcrumb-item">
                        <i class="fas fa-home"></i>
                        <span>دوره‌ها</span>
                    </a>
                    <span class="breadcrumb-separator">/</span>
                    <a asp-controller="TeachingPlan" asp-action="Index" asp-route-courseId="@courseId" class="breadcrumb-item">
                        @courseTitle
                    </a>
                    <span class="breadcrumb-separator">/</span>
                    <a asp-controller="ScheduleItem" asp-action="Index" asp-route-teachingPlanId="@teachingPlanId" class="breadcrumb-item">
                        آیتم‌های آموزشی
                    </a>
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-current">ایجاد آیتم جدید</span>
                </nav>
                <h1 class="page-title-modern">
                    <i class="fas fa-magic"></i>
                    ایجاد آیتم آموزشی جدید
                </h1>
                <p class="page-subtitle-modern">محتوای آموزشی جذاب و تعاملی برای دانش‌آموزان ایجاد کنید</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="header-actions">
                    <button type="button" class="btn-preview-modern" id="previewBtn">
                        <i class="fas fa-eye"></i>
                        <span>پیش‌نمایش</span>
                    </button>
                    <a asp-action="Index" asp-route-teachingPlanId="@teachingPlanId" class="btn-back-modern">
                        <i class="fas fa-arrow-right"></i>
                        <span>بازگشت</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Step Progress Indicator -->
<div class="step-progress-container">
    <div class="step-progress">
        <div class="step-progress-bar">
            <div class="step-progress-fill" id="stepProgressFill"></div>
        </div>
        <div class="step-indicators" id="stepIndicators">
            <div class="step-indicator current" data-step="1">
                <div class="step-indicator-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="step-indicator-text">
                    <div class="step-indicator-title">اطلاعات کلی</div>
                    <div class="step-indicator-desc">عنوان و نوع آیتم</div>
                </div>
            </div>
            <div class="step-indicator" data-step="2">
                <div class="step-indicator-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="step-indicator-text">
                    <div class="step-indicator-title">زمان‌بندی</div>
                    <div class="step-indicator-desc">تاریخ و امتیاز</div>
                </div>
            </div>
            <div class="step-indicator" data-step="3">
                <div class="step-indicator-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="step-indicator-text">
                    <div class="step-indicator-title">تخصیص</div>
                    <div class="step-indicator-desc">گروه و زیرمبحث</div>
                </div>
            </div>
            <div class="step-indicator" data-step="4">
                <div class="step-indicator-icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="step-indicator-text">
                    <div class="step-indicator-title">محتوای آموزشی</div>
                    <div class="step-indicator-desc">طراحی محتوا</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="modern-content-container">
    <div class="container-fluid">
        <div class="row">
            <!-- Main Form -->
            <div class="col-12">
                <div class="modern-form-container">
                    <form asp-action="Create" method="post" id="createItemForm" class="modern-form">
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.TeachingPlanId)
                        <input name="id" value="0" type="hidden" />
                        <!-- Hidden fields for multi-select values -->
                        <input type="hidden" id="selectedGroupIds" name="GroupIds" />
                        <input type="hidden" id="selectedSubChapterIds" name="SubChapterIds" />
                        <!-- Step 1: Basic Information -->
                        <div class="form-step active" data-step="basic">
                            <div class="step-header">
                                <div class="step-icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div class="step-info">
                                    <h3 class="step-title">اطلاعات کلی</h3>
                                    <p class="step-description">عنوان، نوع و توضیحات آیتم آموزشی را تعیین کنید</p>
                                </div>
                            </div>

                            <div class="step-content">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group-modern">
                                            <label asp-for="Title" class="form-label-modern">
                                                <i class="fas fa-heading"></i>
                                                <span>عنوان آیتم آموزشی</span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="input-group-modern">
                                                <input asp-for="Title" 
                                                       class="form-input-modern" 
                                                       placeholder="مثال: تمرین ریاضی فصل اول - حل معادلات درجه دوم" 
                                                       autocomplete="off"
                                                       id="itemTitle" />
                                                <div class="input-feedback">
                                                    <span class="char-count">0/100</span>
                                                </div>
                                            </div>
                                            <span asp-validation-for="Title" class="validation-error-modern"></span>
                                            <div class="input-hint">عنوان جذاب و واضح انتخاب کنید که دانش‌آموزان را ترغیب کند</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="form-group-modern">
                                            <label asp-for="Type" class="form-label-modern">
                                                <i class="fas fa-tasks"></i>
                                                <span>نوع آیتم</span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <select asp-for="Type" class="form-select-modern" id="itemType" required>
                                                <option value="">انتخاب نوع آیتم...</option>
                                                @foreach (var type in scheduleItemTypes)
                                                {
                                                    <option value="@type.GetType().GetProperty("Value")?.GetValue(type)" 
                                                            data-description="@type.GetType().GetProperty("Description")?.GetValue(type)">
                                                        @type.GetType().GetProperty("Text")?.GetValue(type)
                                                    </option>
                                                }
                                            </select>
                                            <span asp-validation-for="Type" class="validation-error-modern"></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group-modern">
                                    <label asp-for="Description" class="form-label-modern">
                                        <i class="fas fa-align-right"></i>
                                        <span>توضیحات آیتم</span>
                                    </label>
                                    <div class="rich-editor-container">
                                        <div class="editor-toolbar">
                                            <button type="button" class="toolbar-btn" data-command="bold">
                                                <i class="fas fa-bold"></i>
                                            </button>
                                            <button type="button" class="toolbar-btn" data-command="italic">
                                                <i class="fas fa-italic"></i>
                                            </button>
                                            <button type="button" class="toolbar-btn" data-command="underline">
                                                <i class="fas fa-underline"></i>
                                            </button>
                                            <div class="toolbar-separator"></div>
                                            <button type="button" class="toolbar-btn" data-command="insertUnorderedList">
                                                <i class="fas fa-list-ul"></i>
                                            </button>
                                            <button type="button" class="toolbar-btn" data-command="insertOrderedList">
                                                <i class="fas fa-list-ol"></i>
                                            </button>
                                            <div class="toolbar-separator"></div>
                                            <button type="button" class="toolbar-btn" data-command="createLink">
                                                <i class="fas fa-link"></i>
                                            </button>
                                        </div>
                                        <div class="editor-content" contenteditable="true" id="descriptionEditor" 
                                             placeholder="توضیحات کامل و مفید در مورد آیتم آموزشی، اهداف یادگیری و نحوه انجام آن..."></div>
                                    </div>
                                    <textarea asp-for="Description" class="d-none" id="descriptionHidden"></textarea>
                                    <span asp-validation-for="Description" class="validation-error-modern"></span>
                                    <div class="input-hint">توضیحات کامل و جذاب بنویسید که دانش‌آموزان را راهنمایی کند</div>
                                </div>

                                <div class="type-preview" id="typePreview" style="display: none;">
                                    <div class="preview-header">
                                        <i class="fas fa-eye"></i>
                                        <span>پیش‌نمایش نوع آیتم</span>
                                    </div>
                                    <div class="preview-content" id="typePreviewContent">
                                        <!-- Dynamic content based on selected type -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Schedule Information -->
                        <div class="form-step" data-step="schedule">
                            <div class="step-header">
                                <div class="step-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="step-info">
                                    <h3 class="step-title">زمان‌بندی و امتیاز</h3>
                                    <p class="step-description">تاریخ شروع، مهلت تحویل و امتیاز آیتم را تعیین کنید</p>
                                </div>
                            </div>

                            <div class="step-content">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group-modern">
                                            <label asp-for="StartDate" class="form-label-modern">
                                                <i class="fas fa-play"></i>
                                                <span>تاریخ و زمان شروع</span>
                                                <span class="required-indicator">*</span>
                                            </label>
                                            <div class="datetime-input-group">
                                                <div class="date-input-wrapper">
                                                    <input type="text" id="PersianStartDate" class="form-input-modern persian-datepicker" 
                                                           placeholder="انتخاب تاریخ" data-target="StartDate" name="PersianStartDate" />
                                                    <input asp-for="StartDate" type="hidden" id="StartDate" name="StartDate" />
                                                </div>
                                                <div class="time-input-wrapper">
                                                    <input type="time" id="StartTime" class="form-input-modern" />
                                                </div>
                                                <button type="button" class="datetime-btn" id="setNowBtn">
                                                    <i class="fas fa-clock"></i>
                                                    <span>الان</span>
                                                </button>
                                            </div>
                                            <span asp-validation-for="StartDate" class="validation-error-modern"></span>
                                            <div class="input-hint">زمانی که دانش‌آموزان می‌توانند شروع به کار کنند</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group-modern">
                                            <label asp-for="DueDate" class="form-label-modern">
                                                <i class="fas fa-clock"></i>
                                                <span>تاریخ و زمان مهلت</span>
                                            </label>
                                            <div class="datetime-input-group">
                                                <div class="date-input-wrapper">
                                                    <input type="text" id="PersianDueDate" class="form-input-modern persian-datepicker" 
                                                           placeholder="انتخاب تاریخ" data-target="DueDate" name="PersianDueDate" />
                                                    <input asp-for="DueDate" type="hidden" id="DueDate" name="DueDate" />
                                                </div>
                                                <div class="time-input-wrapper">
                                                    <input type="time" id="DueTime" class="form-input-modern" />
                                                </div>
                                                <button type="button" class="datetime-btn" id="setWeekBtn">
                                                    <i class="fas fa-calendar-week"></i>
                                                    <span>یک هفته</span>
                                                </button>
                                            </div>
                                            <span asp-validation-for="DueDate" class="validation-error-modern"></span>
                                            <div class="input-hint">آخرین مهلت تحویل آیتم (اختیاری)</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group-modern">
                                            <label asp-for="MaxScore" class="form-label-modern">
                                                <i class="fas fa-star"></i>
                                                <span>حداکثر امتیاز</span>
                                            </label>
                                            <div class="score-input-group">
                                                <input asp-for="MaxScore" type="number" class="form-input-modern" min="0" max="100" step="0.1" placeholder="0" id="maxScore" />
                                                <div class="score-presets">
                                                    <button type="button" class="score-preset" data-score="10">10</button>
                                                    <button type="button" class="score-preset" data-score="20">20</button>
                                                    <button type="button" class="score-preset" data-score="50">50</button>
                                                    <button type="button" class="score-preset" data-score="100">100</button>
                                                </div>
                                            </div>
                                            <span asp-validation-for="MaxScore" class="validation-error-modern"></span>
                                            <div class="input-hint">امتیاز کامل برای این آیتم (0-100)</div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group-modern">
                                            <label class="form-label-modern">
                                                <i class="fas fa-cog"></i>
                                                <span>تنظیمات آیتم</span>
                                            </label>
                                            <div class="checkbox-group-modern">
                                                <div class="checkbox-item-modern">
                                                    <input asp-for="IsMandatory" class="checkbox-input-modern" type="checkbox" id="isMandatory" />
                                                    <label for="isMandatory" class="checkbox-label-modern">
                                                        <div class="checkbox-custom"></div>
                                                        <div class="checkbox-content">
                                                            <div class="checkbox-title">اجباری
                                                                <span class="checkbox-desc">(دانش‌آموزان باید حتماً این آیتم را انجام دهند)</span>

                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>
                                            <span asp-validation-for="IsMandatory" class="validation-error-modern"></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="duration-calculator" id="durationCalculator" style="display: none;">
                                    <div class="calculator-header">
                                        <i class="fas fa-calculator"></i>
                                        <span>محاسبه مدت زمان</span>
                                    </div>
                                    <div class="calculator-content">
                                        <div class="duration-display">
                                            <span class="duration-label">مدت زمان:</span>
                                            <span class="duration-value" id="durationValue">-</span>
                                        </div>
                                        <div class="duration-hint">مدت زمان بین شروع و مهلت تحویل</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Assignment Information -->
                        <div class="form-step" data-step="assignment">
                            <div class="step-header">
                                <div class="step-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="step-info">
                                    <h3 class="step-title">تخصیص و گروه‌بندی</h3>
                                    <p class="step-description">گروه‌های هدف و زیرمباحث مرتبط را انتخاب کنید</p>
                                </div>
                            </div>

                            <div class="step-content">
                                <!-- Group Selection Section -->
                                <div class="assignment-section">
                                    <div class="section-header">
                                        <div class="section-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <div class="section-info">
                                            <h4 class="section-title">تخصیص گروه‌ها</h4>
                                            <p class="section-description">گروه‌های هدف را انتخاب کنید</p>
                                        </div>
                                    </div>
                                    
                                    <div class="badge-selection-container">
                                        <div class="selection-hint">
                                            <i class="fas fa-info-circle"></i>
                                            <span>اگر گروهی انتخاب نکنید، آیتم برای همه گروه‌ها خواهد بود</span>
                                        </div>
                                        <div class="badge-grid" id="groupBadgeGrid">
                                            <!-- Groups will be loaded dynamically as badges -->
                                        </div>
                                        <div class="selected-summary" id="groupSelectionSummary">
                                            <span class="summary-text">هیچ گروهی انتخاب نشده - برای همه گروه‌ها</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- SubChapter Selection Section -->
                                <div class="assignment-section">
                                    <div class="section-header">
                                        <div class="section-icon">
                                            <i class="fas fa-list-alt"></i>
                                        </div>
                                        <div class="section-info">
                                            <h4 class="section-title">زیرمباحث مرتبط</h4>
                                            <p class="section-description">زیرمباحث مرتبط را انتخاب کنید</p>
                                        </div>
                                        <div class="required-badge">
                                            <span>اجباری</span>
                                        </div>
                                    </div>
                                    
                                    <div class="chapter-hierarchy-container">
                                        <div class="selection-hint">
                                            <i class="fas fa-info-circle"></i>
                                            <span>انتخاب حداقل یک زیرمبحث اجباری است</span>
                                        </div>
                                        <div class="chapter-list" id="chapterList">
                                            <!-- Chapters and subchapters will be loaded dynamically -->
                                        </div>
                                        <div class="selected-summary" id="subChapterSelectionSummary">
                                            <span class="summary-text">هیچ زیرمبحثی انتخاب نشده</span>
                                        </div>
                                        <div class="validation-message" id="subChapterValidationError" style="display: none;">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span>انتخاب حداقل یک زیرمبحث اجباری است</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Assignment Preview Section -->
                                <div class="assignment-preview-modern" id="assignmentPreview">
                                    <div class="preview-header-modern">
                                        <div class="preview-icon">
                                            <i class="fas fa-eye"></i>
                                        </div>
                                        <div class="preview-title">
                                            <h5>پیش‌نمایش تخصیص</h5>
                                            <p>خلاصه تنظیمات انتخاب شده</p>
                                        </div>
                                    </div>
                                    <div class="preview-content-modern">
                                        <div class="preview-item">
                                            <div class="preview-item-icon">
                                                <i class="fas fa-users"></i>
                                            </div>
                                            <div class="preview-item-content">
                                                <div class="preview-item-label">گروه‌های هدف</div>
                                                <div class="preview-item-value" id="targetGroups">همه گروه‌ها</div>
                                            </div>
                                        </div>
                                        <div class="preview-item">
                                            <div class="preview-item-icon">
                                                <i class="fas fa-list-alt"></i>
                                            </div>
                                            <div class="preview-item-content">
                                                <div class="preview-item-label">زیرمباحث مرتبط</div>
                                                <div class="preview-item-value" id="relatedSubChapters">انتخاب نشده</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Content Design Section -->
                        <div class="form-step" data-step="content">
                            <div class="step-header">
                                <div class="step-icon">
                                    <i class="fas fa-paint-brush"></i>
                                </div>
                                <div class="step-info">
                                    <h3 class="step-title">طراحی محتوای آموزشی</h3>
                                    <p class="step-description">محتوای تعاملی و جذاب برای دانش‌آموزان طراحی کنید</p>
                                </div>
                            </div>

                            <div class="step-content">
                                <div class="content-type-selector" id="contentTypeSelector" style="display: none;">
                                    <div class="selector-header">
                                        <i class="fas fa-magic"></i>
                                        <span>انتخاب نوع محتوا</span>
                                    </div>
                                    <div class="content-types-grid" id="contentTypesGrid">
                                        <!-- Dynamic content types will be loaded here -->
                                    </div>
                                </div>

                                <div class="content-designer" id="contentDesigner" style="display: none;">
                                    <div class="designer-header">
                                        <div class="designer-title">
                                            <i class="fas fa-edit"></i>
                                            <span>طراحی محتوا</span>
                                        </div>
                                        <div class="designer-actions">
                                            <button type="button" class="designer-btn" id="previewContentBtn">
                                                <i class="fas fa-eye"></i>
                                                <span>پیش‌نمایش</span>
                                            </button>
                                            <button type="button" class="designer-btn" id="resetContentBtn">
                                                <i class="fas fa-undo"></i>
                                                <span>بازنشانی</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="designer-content" id="contentDesignContainer">
                                        <!-- Content design will be loaded dynamically based on item type -->
                                    </div>
                                </div>

                                <div class="content-templates" id="contentTemplates" style="display: none;">
                                    <div class="templates-header">
                                        <i class="fas fa-layer-group"></i>
                                        <span>قالب‌های آماده</span>
                                    </div>
                                    <div class="templates-grid" id="templatesGrid">
                                        <!-- Templates will be loaded dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Navigation -->
                        <div class="form-navigation">
                            <div class="nav-buttons">
                                <button type="button" class="nav-btn nav-prev" id="prevStepBtn" disabled>
                                    <i class="fas fa-arrow-right"></i>
                                    <span>قبلی</span>
                                </button>
                                <button type="button" class="nav-btn nav-next" id="nextStepBtn">
                                    <span>بعدی</span>
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <button type="submit" class="nav-btn nav-submit" id="submitBtn" style="display: none;">
                                    <i class="fas fa-check"></i>
                                    <span>ایجاد آیتم</span>
                                </button>
                            </div>
                            <div class="nav-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <span class="progress-text" id="progressText">مرحله 1 از 4</span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="fas fa-eye"></i>
                    پیش‌نمایش آیتم آموزشی
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                <button type="button" class="btn btn-primary" id="saveFromPreviewBtn">ذخیره آیتم</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jalaali.js"></script>
    <script src="~/js/persian-datepicker.js"></script>
    <script src="~/js/datepicker-init.js"></script>
    <script src="~/js/areas/teacher/schedule-items/schedule-item-form.js"></script>
}

@section Styles {
    <link href="~/css/persian-datepicker.css" rel="stylesheet" />
    <link href="~/css/areas/teacher/schedule-items/schedule-item-form.css" rel="stylesheet" />
}
