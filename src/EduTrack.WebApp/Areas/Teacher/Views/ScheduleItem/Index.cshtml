@model List<EduTrack.Application.Common.Models.ScheduleItems.ScheduleItemDto>
@using EduTrack.Domain.Extensions
@{
    ViewData["Title"] = "مدیریت آیتم‌های آموزشی";
    var teachingPlanId = ViewBag.TeachingPlanId as int? ?? 0;
    var teachingPlanTitle = ViewBag.TeachingPlanTitle as string ?? "برنامه آموزشی";
    var courseTitle = ViewBag.CourseTitle as string ?? "دوره";
    var courseId = ViewBag.CourseId as int? ?? 0;
    var isCourseScope = ViewBag.IsCourseScope as bool? ?? false;
    var isSessionScope = ViewBag.IsSessionScope as bool? ?? false;
    var sessionReportId = ViewBag.SessionReportId as int? ?? 0;
    var sessionTitle = ViewBag.SessionTitle as string ?? string.Empty;
    var stats = ViewBag.Stats as EduTrack.Application.Common.Models.ScheduleItems.ScheduleItemStatsDto ?? new EduTrack.Application.Common.Models.ScheduleItems.ScheduleItemStatsDto();
    var itemTypes = Enum.GetValues<EduTrack.Domain.Enums.ScheduleItemType>()
        .Select(t => new { Value = (int)t, Name = t.GetDisplayName() })
        .ToList();
}

<div class="schedule-items-container"
     data-teaching-plan-id="@teachingPlanId"
     data-course-id="@courseId"
     data-course-scope="@(isCourseScope ? "true" : "false")"
     data-session-scope="@(isSessionScope ? "true" : "false")"
     data-session-report-id="@sessionReportId">

    @if (isSessionScope)
    {
        <div class="session-context-banner">
            <div class="context-info">
                <i class="fas fa-chalkboard-teacher"></i>
                <span>
                    تکالیف ثبت شده برای جلسه
                    @(string.IsNullOrWhiteSpace(sessionTitle) ? $"شماره {sessionReportId}" : sessionTitle)
                </span>
            </div>
            <div class="context-actions">
                <a asp-controller="TeachingSessions"
                   asp-action="Details"
                   asp-route-id="@sessionReportId"
                   class="btn-outline-secondary">
                    <i class="fas fa-arrow-right"></i>
                    <span>بازگشت به جزئیات جلسه</span>
                </a>
            </div>
        </div>
    }

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-list"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@stats.TotalItems</div>
                <div class="stat-label">کل آیتم‌ها</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-play-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@stats.ActiveItems</div>
                <div class="stat-label">آیتم‌های فعال</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@stats.CompletedItems</div>
                <div class="stat-label">تکمیل شده</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@stats.OverdueItems</div>
                <div class="stat-label">منقضی شده</div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="filters-section-minimal">
        <div class="filters-container">
            <div class="filters-top-row">
                <div class="search-input-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="جستجو در آیتم‌ها..." class="search-input">
                </div>
                <div class="sort-container">
                    <select id="sortSelect" class="filter-select">
                        <option value="start-desc">شروع (جدیدترین)</option>
                        <option value="start-asc">شروع (قدیمی‌ترین)</option>
                        <option value="due-asc">نزدیک‌ترین مهلت</option>
                        <option value="due-desc">دورترین مهلت</option>
                        <option value="title-asc">عنوان (الف تا ی)</option>
                        <option value="title-desc">عنوان (ی تا الف)</option>
                    </select>
                </div>
                <button type="button" class="btn-icon btn-clear-filters" id="clearFilters" aria-label="پاک کردن فیلترها" hidden>
                    <i class="fas fa-times-circle"></i>
                </button>
            </div>

            <div class="filter-chips-row">
                <div class="chips-group" aria-label="نوع آیتم">
                    <button type="button" class="filter-chip active" data-type="">همه</button>
                    @foreach (var t in itemTypes)
                    {
                        <button type="button" class="filter-chip" data-type="@t.Value">@t.Name</button>
                    }
                </div>
                <div class="chips-group" aria-label="وضعیت">
                    <button type="button" class="filter-chip active" data-status="">همه وضعیت‌ها</button>
                    <button type="button" class="filter-chip" data-status="0">پیش‌نویس</button>
                    <button type="button" class="filter-chip" data-status="1">منتشر شده</button>
                    <button type="button" class="filter-chip" data-status="2">فعال</button>
                    <button type="button" class="filter-chip" data-status="3">تکمیل شده</button>
                    <button type="button" class="filter-chip" data-status="4">منقضی شده</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Items Grid -->
    <div class="schedule-items-grid" id="scheduleItemsGrid">
        @if (Model.Any())
        {
            @foreach (var item in Model)
            {
                <div class="schedule-item-card" data-item-id="@item.Id" data-type="@((int)item.Type)" data-status="@((int)item.Status)">
                    <div class="item-header">
                        <div class="item-type-badge type-@((int)item.Type)">
                            <i class="@GetTypeIcon(item.Type)"></i>
                            @item.Type.GetDisplayName()
                        </div>
                        @if (!isSessionScope)
                        {
                            <div class="item-actions">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" data-action="edit" data-item-id="@item.Id">
                                            <i class="fas fa-edit"></i> ویرایش
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" data-action="duplicate" data-item-id="@item.Id">
                                            <i class="fas fa-copy"></i> کپی
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" data-action="delete" data-item-id="@item.Id">
                                            <i class="fas fa-trash"></i> حذف
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        }
                    </div>
                    
                    <div class="item-content">
                        <h5 class="item-title">@item.Title</h5>
                        @if (!string.IsNullOrEmpty(item.Description))
                        {
                            <p class="item-description">@Html.Raw(item.Description)</p>
                        }
                        
                        <div class="item-meta">
                            <div class="meta-item">
                                <i class="fas fa-calendar-alt"></i>
                                <span>شروع: @item.StartDate.ToString("yyyy/MM/dd")</span>
                            </div>
                            @if (item.DueDate.HasValue)
                            {
                                <div class="meta-item">
                                    <i class="fas fa-clock"></i>
                                    <span>مهلت: @item.DueDate.Value.ToString("yyyy/MM/dd")</span>
                                </div>
                            }
                            @if (item.MaxScore.HasValue)
                            {
                                <div class="meta-item">
                                    <i class="fas fa-star"></i>
                                    <span>امتیاز: @item.MaxScore</span>
                                </div>
                            }
                        </div>
                    </div>
                    
                    <div class="item-footer">
                        <div class="item-status status-@((int)item.Status)">
                            @item.StatusText
                        </div>
                        @if (!string.IsNullOrEmpty(item.GroupName))
                        {
                            <div class="item-group">
                                <i class="fas fa-users"></i>
                                @item.GroupName
                            </div>
                        }
                    </div>
                </div>
            }
        }
        else
        {
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-tasks"></i>
                </div>
                <h3>هیچ آیتم آموزشی وجود ندارد</h3>
                <p>برای شروع، اولین آیتم آموزشی خود را ایجاد کنید.</p>
                @if (isSessionScope)
                {
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <h3>هنوز تکلیفی برای این جلسه ثبت نشده</h3>
                        <p>از صفحه جزئیات جلسه می‌توانید تکلیف جدید ثبت کنید.</p>
                    </div>
                }
                else if (isCourseScope)
                {
                    <a asp-action="CreateOrEdit" asp-route-courseId="@courseId" class="btn-action-primary">
                        <i class="fas fa-plus"></i>
                        <span>افزودن آیتم جدید</span>
                    </a>
                }
                else
                {
                    <a asp-action="CreateOrEdit" asp-route-teachingPlanId="@teachingPlanId" class="btn-action-primary">
                        <i class="fas fa-plus"></i>
                        <span>افزودن آیتم جدید</span>
                    </a>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <!-- Core Utilities -->
    <script src="~/js/utils/common.js" asp-append-version="true"></script>
    <script src="~/js/utils/validation.js" asp-append-version="true"></script>
    <script src="~/js/utils/dom-helpers.js" asp-append-version="true"></script>

    <!-- Services -->
    <script src="~/js/services/notification-service.js" asp-append-version="true"></script>
    <script src="~/js/services/modal-service.js" asp-append-version="true"></script>

    <!-- API Services -->
    <script src="~/js/api/schedule-item-api.js" asp-append-version="true"></script>
    <script src="~/js/api/schedule-api.js" asp-append-version="true"></script>
    <script src="~/js/api/student-group-api.js" asp-append-version="true"></script>

    <!-- Core Initialization -->
    <script src="~/js/edutrack-core.js" asp-append-version="true"></script>
    <script src="~/js/areas/teacher/schedule-items/schedule-items.js" asp-append-version="true"></script>
}

@section Styles {
    <link href="~/css/areas/teacher/schedule-items/schedule-items.css" rel="stylesheet" />
}

@functions {
    string GetTypeIcon(EduTrack.Domain.Enums.ScheduleItemType type)
    {
        return type switch
        {
            EduTrack.Domain.Enums.ScheduleItemType.Reminder => "fas fa-bell",
            EduTrack.Domain.Enums.ScheduleItemType.Writing => "fas fa-pen",
            EduTrack.Domain.Enums.ScheduleItemType.Audio => "fas fa-volume-up",
            EduTrack.Domain.Enums.ScheduleItemType.GapFill => "fas fa-edit",
            EduTrack.Domain.Enums.ScheduleItemType.MultipleChoice => "fas fa-list-ul",
            EduTrack.Domain.Enums.ScheduleItemType.Match => "fas fa-link",
            EduTrack.Domain.Enums.ScheduleItemType.ErrorFinding => "fas fa-search",
            EduTrack.Domain.Enums.ScheduleItemType.CodeExercise => "fas fa-code",
            EduTrack.Domain.Enums.ScheduleItemType.Quiz => "fas fa-question-circle",
            _ => "fas fa-tasks"
        };
    }
}
