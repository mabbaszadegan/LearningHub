@model EduTrack.Application.Common.Models.ScheduleItems.CreateScheduleItemRequest
@{
    var isEditMode = ViewBag.IsEditMode as bool? ?? false;
    var scheduleItemId = ViewBag.ScheduleItemId as int? ?? 0;
    ViewData["Title"] = isEditMode ? "ویرایش آیتم آموزشی" : "ایجاد آیتم آموزشی جدید";
    var teachingPlanId = ViewBag.TeachingPlanId as int? ?? 0;
    var teachingPlanTitle = ViewBag.TeachingPlanTitle as string ?? "برنامه آموزشی";
    var courseTitle = ViewBag.CourseTitle as string ?? "دوره";
    var courseId = ViewBag.CourseId as int? ?? 0;
}


<!-- Step Progress Indicator -->
<div class="step-progress-container compact">
    <div class="step-progress compact">
        <div class="step-indicators" id="stepIndicators">
            <div class="step-indicator current" data-step="1">
                <div class="step-indicator-icon">
                    <span class="step-number">1</span>
                </div>
                <span class="step-indicator-label">اطلاعات کلی</span>
            </div>
            <div class="step-indicator" data-step="2">
                <div class="step-indicator-icon">
                    <span class="step-number">2</span>
                </div>
                <span class="step-indicator-label">زمان‌بندی</span>
            </div>
            <div class="step-indicator" data-step="3">
                <div class="step-indicator-icon">
                    <span class="step-number">3</span>
                </div>
                <span class="step-indicator-label">تخصیص</span>
            </div>
            <div class="step-indicator" data-step="4">
                <div class="step-indicator-icon">
                    <span class="step-number">4</span>
                </div>
                <span class="step-indicator-label">محتوای آموزشی</span>
            </div>
        </div>
        <div class="step-progress-bar">
            <div class="step-progress-fill" id="stepProgressFill"></div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="modern-content-container">
    <div class="container-fluid">
        <div class="row">
            <!-- Main Form -->
            <div class="col-12">
                <div class="modern-form-container">
                    <form asp-action="CreateOrEdit" method="post" id="createItemForm" class="modern-form">
                        @Html.AntiForgeryToken()
                        <input asp-for="TeachingPlanId" type="hidden" />
                        <input name="id" value="@scheduleItemId" type="hidden" />
                        <!-- Hidden fields for multi-select values -->
                        <input type="hidden" id="selectedGroupIds" name="GroupIds" />
                        <input type="hidden" id="selectedSubChapterIds" name="SubChapterIds" />
                        <input type="hidden" id="selectedStudentIds" name="StudentIds" />
                        <!-- Hidden field for content JSON -->
                        <input type="hidden" id="contentJson" name="ContentJson" value="@Model.ContentJson" />

                        <!-- Step 1: Basic Information -->
                        @await Html.PartialAsync("_Step1BasicInfo", Model)

                        <!-- Step 2: Schedule Information -->
                        @await Html.PartialAsync("_Step2Scheduling", Model)

                        <!-- Step 3: Assignment Information -->
                        @await Html.PartialAsync("_Step3Assignment", Model)

                        <!-- Step 4: Content Design Section -->
                        @await Html.PartialAsync("_Step4Content", Model)

                        
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="fas fa-eye"></i>
                    پیش‌نمایش آیتم آموزشی
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-teacher btn-secondary" data-bs-dismiss="modal">بستن</button>
                <button type="button" class="btn-teacher btn-primary" id="editFromPreview">ویرایش</button>
            </div>
        </div>
    </div>
</div>

<!-- Global Form Navigation (fixed at bottom; placed outside form and steps to avoid nesting issues) -->
<div class="form-navigation">
    <div class="nav-buttons">
        <button type="button" class="btn-teacher btn-nav-prev" id="prevStepBtn" style="display: none;" title="مرحله قبلی">
            <i class="fas fa-chevron-right"></i>
            <span>مرحله قبلی</span>
        </button>
        <button type="button" class="btn-teacher btn-nav-next" id="nextStepBtn" title="ثبت مرحله و ادامه">
            <span>ادامه</span>
            <i class="fas fa-chevron-left"></i>
        </button>
        <button type="submit" class="btn-teacher btn-nav-submit" id="submitBtn" style="display: none;" title="ثبت نهایی">
            <span>ثبت نهایی</span>
            <i class="fas fa-check"></i>
        </button>
    </div>
    <div class="nav-progress">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <span class="progress-text" id="progressText">مرحله 1 از 4</span>
    </div>
    
    <!-- Hidden real submit button to trigger form submit programmatically if needed -->
    <button type="submit" form="createItemForm" style="display:none"></button>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/areas/teacher/schedule-items/schedule-item-form.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/lib/ckeditor/ckeditor5.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/lib/ckeditor/ckeditor5-content.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/lib/ckeditor/ckeditor5-editor.css" asp-append-version="true" />
}
@section Scripts {
    <!-- Core Utilities -->
    <script src="~/js/utils/common.js" asp-append-version="true"></script>
    <script src="~/js/utils/validation.js" asp-append-version="true"></script>
    <script src="~/js/utils/dom-helpers.js" asp-append-version="true"></script>
    
    <!-- Services -->
    <script src="~/js/services/notification-service.js" asp-append-version="true"></script>
    <script src="~/js/services/modal-service.js" asp-append-version="true"></script>
    
    <!-- API Services -->
    <script src="~/js/api/schedule-item-api.js" asp-append-version="true"></script>
    <script src="~/js/api/schedule-api.js" asp-append-version="true"></script>
    <script src="~/js/api/student-group-api.js" asp-append-version="true"></script>
    
    <!-- Core Initialization -->
    <script src="~/js/edutrack-core.js" asp-append-version="true"></script>
    
    <!-- CKEditor -->
    <script type="importmap" src="~/js/importmaps/ckeditor-importmap.json" asp-append-version="true"></script>
    <script type="module" src="~/js/areas/teacher/schedule-items/ckeditor-init.js" asp-append-version="true"></script>

    <!-- Lazy Loading -->
    <script src="~/js/lazy-loading.js" asp-append-version="true"></script>
    
    <!-- Step Managers -->
    <script src="~/js/areas/teacher/schedule-items/step1-basics.js" asp-append-version="true"></script>
    <script src="~/js/areas/teacher/schedule-items/step2-timing.js" asp-append-version="true"></script>
    <script src="~/js/areas/teacher/schedule-items/step3-assignment.js" asp-append-version="true"></script>
    <!-- step4-content.js is loaded in _Step4Content.cshtml partial -->
    <script src="~/js/areas/teacher/schedule-items/schedule-item-form.js" asp-append-version="true"></script>
}
