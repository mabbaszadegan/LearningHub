@using EduTrack.Application.Common.Models.StudySessions
@model EducationalContentWithStudyStatsDto
@{
    ViewData["Title"] = $"مطالعه: {Model.Title}";
}

@section Styles {
    <link rel="stylesheet" href="~/css/areas/student/educational-content/study-content.css" asp-append-version="true" />
}

<!-- Ultra Minimal Study Header -->
<div class="study-content-header-ultra-minimal">
    <div class="study-header-container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="study-breadcrumb-minimal">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a asp-area="Student" asp-controller="Home" asp-action="Index" class="breadcrumb-link">
                        <i class="fas fa-home"></i>
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a asp-area="Student" asp-controller="Course" asp-action="Index" class="breadcrumb-link">
                        <i class="fas fa-book-open"></i>
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="javascript:history.back()" class="breadcrumb-link">
                        دوره
                    </a>
                </li>
                <li class="breadcrumb-item active">
                    <i class="fas fa-play"></i>
                </li>
            </ol>
        </nav>
        
        <!-- Content Title & Timer -->
        <div class="study-title-timer-row">
            <div class="content-title-section">
                <h1 class="content-title-compact">@Model.Title</h1>
                <div class="study-stats-minimal">
                    <span class="stat-item">
                        <i class="fas fa-clock"></i>
                        <span id="total-study-time">@Model.StudyStatistics.TotalStudyTime.ToString(@"hh\:mm\:ss")</span>
                    </span>
                    <span class="stat-item">
                        <i class="fas fa-repeat"></i>
                        <span id="study-sessions-count">@Model.StudyStatistics.StudySessionsCount</span>
                    </span>
                    <span class="stat-item">
                        <i class="fas fa-calendar"></i>
                        <span id="last-study-date">@(Model.StudyStatistics.LastStudyDate?.ToString("yyyy/MM/dd") ?? "هیچ‌گاه")</span>
                    </span>
                </div>
            </div>
            
            <!-- Study Timer -->
            <div class="study-timer-compact">
                <div class="timer-display-compact">
                    <i class="fas fa-play-circle timer-icon-compact"></i>
                    <span class="timer-text-compact" id="timer-text">00:00:00</span>
                </div>
                <div class="timer-controls-compact">
                    <button class="timer-btn-compact" id="timer-toggle" title="توقف تایمر">
                        <i class="fas fa-pause"></i>
                    </button>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="header-actions-compact">
                <a href="javascript:history.back()" class="btn-back-compact" title="بازگشت">
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Area -->
<div class="study-content-container">
    <div class="content-wrapper">
        <!-- Content Type Header -->
        <div class="content-type-header">
            <div class="content-type-icon">
                @switch (Model.Type)
                {
                    case EduTrack.Domain.Enums.EducationalContentType.Text:
                        <i class="fas fa-file-text"></i>
                        break;
                    case EduTrack.Domain.Enums.EducationalContentType.Image:
                        <i class="fas fa-image"></i>
                        break;
                    case EduTrack.Domain.Enums.EducationalContentType.Video:
                        <i class="fas fa-video"></i>
                        break;
                    case EduTrack.Domain.Enums.EducationalContentType.Audio:
                        <i class="fas fa-volume-up"></i>
                        break;
                    case EduTrack.Domain.Enums.EducationalContentType.PDF:
                        <i class="fas fa-file-pdf"></i>
                        break;
                    case EduTrack.Domain.Enums.EducationalContentType.ExternalUrl:
                        <i class="fas fa-external-link-alt"></i>
                        break;
                    case EduTrack.Domain.Enums.EducationalContentType.File:
                        <i class="fas fa-file"></i>
                        break;
                    default:
                        <i class="fas fa-file"></i>
                        break;
                }
            </div>
            <div class="content-type-info">
                <h2 class="content-type-title">@Model.Title</h2>
                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    <p class="content-description">@Model.Description</p>
                }
            </div>
        </div>

        <!-- Content Display -->
        <div class="content-display">
            @switch (Model.Type)
            {
                case EduTrack.Domain.Enums.EducationalContentType.Text:
                    <div class="text-content">
                        @Html.Raw(Model.TextContent)
                    </div>
                    break;
                    
                case EduTrack.Domain.Enums.EducationalContentType.Image:
                    @if (Model.File != null)
                    {
                        <div class="image-content">
                            <img src="@Url.Action("Download", "Files", new { id = Model.File.Id })" 
                                 alt="@Model.Title" 
                                 class="content-image" />
                        </div>
                    }
                    break;
                    
                case EduTrack.Domain.Enums.EducationalContentType.Video:
                    @if (Model.File != null)
                    {
                        <div class="video-content">
                            <video controls class="content-video">
                                <source src="@Url.Action("Download", "Files", new { id = Model.File.Id })" type="@Model.File.MimeType">
                                مرورگر شما از پخش ویدیو پشتیبانی نمی‌کند.
                            </video>
                        </div>
                    }
                    break;
                    
                case EduTrack.Domain.Enums.EducationalContentType.Audio:
                    @if (Model.File != null)
                    {
                        <div class="audio-content">
                            <audio controls class="content-audio">
                                <source src="@Url.Action("Download", "Files", new { id = Model.File.Id })" type="@Model.File.MimeType">
                                مرورگر شما از پخش صدا پشتیبانی نمی‌کند.
                            </audio>
                        </div>
                    }
                    break;
                    
                case EduTrack.Domain.Enums.EducationalContentType.PDF:
                    @if (Model.File != null)
                    {
                        <div class="pdf-content">
                            <iframe src="@Url.Action("Download", "Files", new { id = Model.File.Id })#toolbar=0&navpanes=0&scrollbar=1" 
                                    class="content-pdf" 
                                    title="@Model.Title"></iframe>
                        </div>
                    }
                    break;
                    
                case EduTrack.Domain.Enums.EducationalContentType.ExternalUrl:
                    @if (!string.IsNullOrEmpty(Model.ExternalUrl))
                    {
                        <div class="external-content">
                            <iframe src="@Model.ExternalUrl" 
                                    class="content-external" 
                                    title="@Model.Title"></iframe>
                        </div>
                    }
                    break;
                    
                case EduTrack.Domain.Enums.EducationalContentType.File:
                    @if (Model.File != null)
                    {
                        <div class="file-content">
                            <div class="file-download-card">
                                <div class="file-icon">
                                    <i class="fas fa-download"></i>
                                </div>
                                <div class="file-info">
                                    <h3>@Model.File.FileName</h3>
                                    <p>حجم: @(Model.File.FileSizeBytes>0 ? (Model.File.FileSizeBytes / 1024 / 1024).ToString("F2") + " مگابایت" : "نامشخص")</p>
                                </div>
                                <a href="@Url.Action("Download", "Files", new { id = Model.File.Id })" 
                                   class="btn-download" 
                                   download="@Model.File.FileName">
                                    <i class="fas fa-download"></i>
                                    دانلود
                                </a>
                            </div>
                        </div>
                    }
                    break;
            }
        </div>
    </div>
</div>

<!-- Exit Confirmation Modal -->
<div class="modal fade" id="exitConfirmationModal" tabindex="-1" aria-labelledby="exitConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exitConfirmationModalLabel">
                    <i class="fas fa-question-circle me-2"></i>تأیید خروج
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="exit-confirmation-content">
                    <div class="confirmation-icon">
                        <i class="fas fa-clock fa-3x text-primary"></i>
                    </div>
                    <h6 class="confirmation-title">آیا می‌خواهید زمان مطالعه ثبت شود؟</h6>
                    <p class="confirmation-message">
                        شما <span id="current-study-time">00:00:00</span> روی این محتوا مطالعه کرده‌اید.
                    </p>
                    <div class="study-time-summary">
                        <div class="time-summary-item">
                            <span class="summary-label">زمان مطالعه فعلی:</span>
                            <span class="summary-value" id="current-session-time">00:00:00</span>
                        </div>
                        <div class="time-summary-item">
                            <span class="summary-label">کل زمان مطالعه:</span>
                            <span class="summary-value" id="total-study-time-summary">@Model.StudyStatistics.TotalStudyTime.ToString(@"hh\:mm\:ss")</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>انصراف
                </button>
                <button type="button" class="btn btn-outline-secondary" id="exit-without-saving">
                    <i class="fas fa-sign-out-alt me-1"></i>خروج بدون ثبت
                </button>
                <button type="button" class="btn btn-primary" id="save-and-exit">
                    <i class="fas fa-save me-1"></i>ثبت و خروج
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Configuration for study content page
        window.studyContentConfig = {
            educationalContentId: @Model.Id,
            currentUserId: '@ViewBag.CurrentUserId',
            activeSessionId: @(ViewBag.ActiveSession?.Id ?? 0),
            startSessionUrl: '@Url.Action("StartStudySession")',
            completeSessionUrl: '@Url.Action("CompleteStudySession")',
            updateDurationUrl: '@Url.Action("UpdateStudySessionDuration")',
            getStatisticsUrl: '@Url.Action("GetStudyStatistics")'
        };
    </script>
    <script src="~/js/areas/student/educational-content/study-content.js" asp-append-version="true"></script>
}
