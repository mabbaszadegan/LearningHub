@model EduTrack.Application.Features.InteractiveLesson.DTOs.InteractiveLessonDto

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">@Model.Title</h3>
                    <div class="card-tools">
                        <div class="progress" style="width: 200px;">
                            <div class="progress-bar" role="progressbar" style="width: @(ViewBag.StudentProgress?.ProgressPercentage ?? 0)%" 
                                 aria-valuenow="@(ViewBag.StudentProgress?.ProgressPercentage ?? 0)" aria-valuemin="0" aria-valuemax="100">
                                @(ViewBag.StudentProgress?.ProgressPercentage ?? 0)%
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> @Model.Description
                        </div>
                    }
                    
                    <div id="lesson-content">
                        @foreach (var item in Model.ContentItems.OrderBy(x => x.Order))
                        {
                            <div class="lesson-item mb-4" data-item-id="@item.Id">
                                @if (item.EducationalContent != null)
                                {
                                    <!-- نمایش محتوای آموزشی -->
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-file-alt"></i> @item.EducationalContent.Title</h5>
                                        </div>
                                        <div class="card-body">
                                            @if (!string.IsNullOrEmpty(item.EducationalContent.Description))
                                            {
                                                <p>@item.EducationalContent.Description</p>
                                            }
                                            
                                            @switch (item.EducationalContent.Type)
                                            {
                                                case EduTrack.Domain.Enums.EducationalContentType.Text:
                                                    <div class="content-text">
                                                        @Html.Raw(item.EducationalContent.TextContent)
                                                    </div>
                                                    break;
                                                case EduTrack.Domain.Enums.EducationalContentType.Image:
                                                    <div class="content-image text-center">
                                                        <img src="/files/@item.EducationalContent.FileId" class="img-fluid" alt="@item.EducationalContent.Title" />
                                                    </div>
                                                    break;
                                                case EduTrack.Domain.Enums.EducationalContentType.Video:
                                                    <div class="content-video text-center">
                                                        <video controls class="img-fluid">
                                                            <source src="/files/@item.EducationalContent.FileId" type="video/mp4">
                                                            مرورگر شما از پخش ویدیو پشتیبانی نمی‌کند.
                                                        </video>
                                                    </div>
                                                    break;
                                                case EduTrack.Domain.Enums.EducationalContentType.ExternalUrl:
                                                    <div class="content-url text-center">
                                                        <a href="@item.EducationalContent.ExternalUrl" target="_blank" class="btn btn-primary">
                                                            <i class="fas fa-external-link-alt"></i> باز کردن لینک
                                                        </a>
                                                    </div>
                                                    break;
                                            }
                                        </div>
                                    </div>
                                }
                                else if (item.InteractiveQuestion != null)
                                {
                                    <!-- نمایش سوال تعاملی -->
                                    <div class="card">
                                        <div class="card-header">
                                            <h5><i class="fas fa-question"></i> سوال</h5>
                                            <span class="badge badge-info">@item.InteractiveQuestion.Points نمره</span>
                                        </div>
                                        <div class="card-body">
                                            <p class="question-text">@item.InteractiveQuestion.QuestionText</p>
                                            
                                            @if (!string.IsNullOrEmpty(item.InteractiveQuestion.Description))
                                            {
                                                <p class="text-muted">@item.InteractiveQuestion.Description</p>
                                            }
                                            
                                            @if (item.InteractiveQuestion.ImageFileId.HasValue)
                                            {
                                                <div class="question-image text-center mb-3">
                                                    <img src="/files/@item.InteractiveQuestion.ImageFileId" class="img-fluid" alt="تصویر سوال" />
                                                </div>
                                            }
                                            
                                            <div class="question-answers" data-question-id="@item.InteractiveQuestion.Id">
                                                @switch (item.InteractiveQuestion.Type)
                                                {
                                                    case EduTrack.Domain.Enums.InteractiveQuestionType.MultipleChoice:
                                                    case EduTrack.Domain.Enums.InteractiveQuestionType.MultipleSelect:
                                                        @foreach (var choice in item.InteractiveQuestion.Choices.OrderBy(c => c.Order))
                                                        {
                                                            <div class="form-check mb-2">
                                                                <input class="form-check-input" type="@(item.InteractiveQuestion.Type == EduTrack.Domain.Enums.InteractiveQuestionType.MultipleSelect ? "checkbox" : "radio")" 
                                                                       name="question_@item.InteractiveQuestion.Id" value="@choice.Id" id="choice_@choice.Id">
                                                                <label class="form-check-label" for="choice_@choice.Id">
                                                                    @choice.Text
                                                                </label>
                                                            </div>
                                                        }
                                                        break;
                                                    case EduTrack.Domain.Enums.InteractiveQuestionType.TextInput:
                                                        <div class="form-group">
                                                            <textarea class="form-control" rows="3" placeholder="پاسخ خود را وارد کنید"></textarea>
                                                        </div>
                                                        break;
                                                    case EduTrack.Domain.Enums.InteractiveQuestionType.TrueFalse:
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="radio" name="question_@item.InteractiveQuestion.Id" value="true" id="true_@item.InteractiveQuestion.Id">
                                                            <label class="form-check-label" for="true_@item.InteractiveQuestion.Id">
                                                                درست
                                                            </label>
                                                        </div>
                                                        <div class="form-check mb-2">
                                                            <input class="form-check-input" type="radio" name="question_@item.InteractiveQuestion.Id" value="false" id="false_@item.InteractiveQuestion.Id">
                                                            <label class="form-check-label" for="false_@item.InteractiveQuestion.Id">
                                                                نادرست
                                                            </label>
                                                        </div>
                                                        break;
                                                }
                                            </div>
                                            
                                            <div class="mt-3">
                                                <button type="button" class="btn btn-success" onclick="submitAnswer(@item.InteractiveQuestion.Id)">
                                                    <i class="fas fa-check"></i> ارسال پاسخ
                                                </button>
                                            </div>
                                            
                                            <div class="answer-feedback mt-3" id="feedback_@item.InteractiveQuestion.Id" style="display: none;">
                                                <!-- بازخورد پاسخ اینجا نمایش داده می‌شود -->
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function submitAnswer(questionId) {
    const questionElement = $(`[data-question-id="${questionId}"]`);
    let answerData = {
        interactiveQuestionId: questionId,
        studentId: '@User.Identity?.Name'
    };
    
    // جمع‌آوری پاسخ بر اساس نوع سوال
    const questionType = questionElement.closest('.card').find('.question-answers').data('question-type');
    
    if (questionType === 'MultipleChoice' || questionType === 'MultipleSelect') {
        const selectedChoices = questionElement.find('input:checked').map(function() {
            return parseInt($(this).val());
        }).get();
        
        if (selectedChoices.length === 0) {
            alert('لطفاً یک گزینه انتخاب کنید');
            return;
        }
        
        answerData.selectedChoiceId = selectedChoices[0]; // برای چند گزینه‌ای، اولین انتخاب
    } else if (questionType === 'TextInput') {
        const textAnswer = questionElement.find('textarea').val();
        if (!textAnswer.trim()) {
            alert('لطفاً پاسخ خود را وارد کنید');
            return;
        }
        answerData.answerText = textAnswer;
    } else if (questionType === 'TrueFalse') {
        const selectedValue = questionElement.find('input:checked').val();
        if (!selectedValue) {
            alert('لطفاً یک گزینه انتخاب کنید');
            return;
        }
        answerData.booleanAnswer = selectedValue === 'true';
    }
    
    // ارسال پاسخ
    $.ajax({
        url: '@Url.Action("SubmitAnswer", "InteractiveLesson")',
        type: 'POST',
        data: answerData,
        success: function(response) {
            if (response.success) {
                showAnswerFeedback(questionId, response.data);
                updateProgress();
            } else {
                alert('خطا: ' + response.error);
            }
        },
        error: function() {
            alert('خطا در ارسال پاسخ');
        }
    });
}

function showAnswerFeedback(questionId, answerData) {
    const feedbackElement = $(`#feedback_${questionId}`);
    const isCorrect = answerData.isCorrect;
    const pointsEarned = answerData.pointsEarned;
    
    let feedbackHtml = '';
    if (isCorrect) {
        feedbackHtml = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> پاسخ شما صحیح است! 
                <strong>${pointsEarned} نمره</strong> کسب کردید.
            </div>
        `;
    } else {
        feedbackHtml = `
            <div class="alert alert-danger">
                <i class="fas fa-times-circle"></i> پاسخ شما نادرست است.
                ${answerData.feedback ? '<br>' + answerData.feedback : ''}
            </div>
        `;
    }
    
    feedbackElement.html(feedbackHtml).show();
    
    // غیرفعال کردن دکمه ارسال
    $(`[data-question-id="${questionId}"]`).closest('.card').find('button').prop('disabled', true);
}

function updateProgress() {
    $.ajax({
        url: '@Url.Action("GetProgress", "InteractiveLesson")',
        type: 'GET',
        data: { interactiveLessonId: @Model.Id },
        success: function(response) {
            if (response.success) {
                const progress = response.data.progressPercentage;
                $('.progress-bar').css('width', progress + '%').attr('aria-valuenow', progress);
                $('.progress-bar').text(progress + '%');
            }
        }
    });
}
</script>

