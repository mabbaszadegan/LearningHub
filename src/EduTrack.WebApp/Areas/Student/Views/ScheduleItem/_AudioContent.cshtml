@model object
@using EduTrack.Application.Common.Models.ScheduleItems
@using EduTrack.Domain.Enums
@using System.Linq
@{
    var content = Model as AudioContent;
}

<div class="audio-content-container-minimal">
    @if (content != null)
    {
        <!-- Combined Blocks and Question Blocks (sorted by Order) -->
        var allBlocks = new List<dynamic>();

        // Add content blocks
        if (content.Blocks != null && content.Blocks.Any())
        {
            foreach (var block in content.Blocks)
            {
                allBlocks.Add(new { Type = "content", Block = (object)block, Order = block.Order });
            }
        }

        // Add question blocks
        if (content.QuestionBlocks != null && content.QuestionBlocks.Any())
        {
            foreach (var questionBlock in content.QuestionBlocks)
            {
                allBlocks.Add(new { Type = "question", Block = (object)questionBlock, Order = questionBlock.Order });
            }
        }

        // Add multiple choice blocks
        if (content.MultipleChoiceBlocks != null && content.MultipleChoiceBlocks.Any())
        {
            foreach (var mcqBlock in content.MultipleChoiceBlocks)
            {
                allBlocks.Add(new { Type = "multiplechoice", Block = (object)mcqBlock, Order = mcqBlock.Order });
            }
        }

        // Sort by Order
        var sortedBlocks = allBlocks.OrderBy(b => b.Order).ToList();

        @if (sortedBlocks.Any())
        {
            <div class="content-blocks-wrapper">
                @{
                    var mcqBlockIndex = 0;
                }
                @foreach (var item in sortedBlocks)
                {
                    var blockType = item.Type;
                    var order = item.Order;

                    @if (blockType == "content")
                    {
                        var block = item.Block as ContentBlock;
                        if (block != null)
                        {
                            <div class="content-block content-block-@block.Type.ToString().ToLower()"
                                 data-block-order="@order"
                                 data-block-id="@block.Id"
                                 data-block-type="content">
                                <div class="content-block-inner">
                                    @await Html.PartialAsync("_ContentBlock", block)
                                </div>
                            </div>
                        }
                    }
                    else if (blockType == "question")
                    {
                        var questionBlock = item.Block as ReminderQuestionBlock;
                        if (questionBlock != null)
                        {
                            <div class="content-block content-block-question"
                                 data-block-order="@order"
                                 data-block-id="@questionBlock.Id"
                                 data-block-type="question">
                                <div class="content-block-inner">
                                    @await Html.PartialAsync("_QuestionBlock", questionBlock)
                                </div>
                            </div>
                        }
                    }
                    else if (blockType == "multiplechoice")
                    {
                        var mcqBlock = item.Block as MultipleChoiceBlock;
                        if (mcqBlock != null)
                        {
                            <div class="content-block content-block-multiplechoice"
                                 data-block-order="@order"
                                 data-block-id="@mcqBlock.Id"
                                 data-block-type="multiplechoice">
                                <div class="content-block-inner">
                                    @{
                                        var scheduleItemId = ViewBag.ScheduleItemId as int? ?? 0;
                                        ViewBag.BlockIndex = mcqBlockIndex;
                                        ViewBag.ScheduleItemType = ScheduleItemType.Audio;
                                        ViewBag.ScheduleItemId = scheduleItemId;
                                    }
                                    @await Html.PartialAsync("_MultipleChoiceBlock", mcqBlock)
                                </div>
                            </div>
                            mcqBlockIndex++;
                        }
                    }
                }
            </div>
        }
        
        <!-- Fallback: Show instruction and audio player if no blocks -->
        @if (!sortedBlocks.Any())
        {
            @if (!string.IsNullOrEmpty(content.Instruction))
            {
                <div class="audio-instruction-minimal">
                    <p>@content.Instruction</p>
                </div>
            }
            
            @if (!string.IsNullOrEmpty(content.AudioUrl))
            {
                <div class="audio-player-minimal">
                    <audio controls class="audio-player-minimal-control" preload="metadata">
                        <source src="@content.AudioUrl" type="audio/mpeg">
                        مرورگر شما از پخش صدا پشتیبانی نمی‌کند.
                    </audio>
                </div>
            }
        }
        
        <!-- Recording controls (show if allowed and there are question blocks or legacy audio) -->
        @if (content.AllowRecording && (content.QuestionBlocks != null && content.QuestionBlocks.Any() || !sortedBlocks.Any()))
        {
            <div class="audio-recording-minimal">
                @if (!string.IsNullOrEmpty(content.RecordingInstructions))
                {
                    <p class="recording-instructions-minimal">@content.RecordingInstructions</p>
                }
                
                <div class="recording-controls-minimal">
                    <button type="button" class="btn-recording btn-recording-start" id="start-recording">
                        <i class="fas fa-microphone"></i>
                        <span>شروع ضبط</span>
                    </button>
                    <button type="button" class="btn-recording btn-recording-stop" id="stop-recording" style="display: none;">
                        <i class="fas fa-stop"></i>
                        <span>توقف</span>
                    </button>
                    <button type="button" class="btn-recording btn-recording-play" id="play-recording" style="display: none;">
                        <i class="fas fa-play"></i>
                        <span>پخش</span>
                    </button>
                </div>
                
                <div id="recording-status" class="recording-status-minimal" style="display: none;">
                    <span id="recording-time">00:00</span>
                </div>
                
                <audio id="recorded-audio" controls class="recorded-audio-minimal" style="display: none;"></audio>
            </div>
        }
        
        <!-- Actions (show if there are question blocks or recording is allowed) -->
        @if ((content.QuestionBlocks != null && content.QuestionBlocks.Any()) || content.AllowRecording)
        {
            <div class="audio-actions-minimal">
                @if (content.AllowRecording)
                {
                    <button type="button" class="btn-action btn-action-save" id="save-audio-answer">
                        <i class="fas fa-save"></i>
                        <span>ذخیره</span>
                    </button>
                }
                <button type="button" class="btn-action btn-action-submit" id="submit-audio-answer">
                    <i class="fas fa-paper-plane"></i>
                    <span>ارسال</span>
                </button>
            </div>
        }
    }
    else
    {
        <div class="content-empty-state">
            <i class="fas fa-info-circle"></i>
            <p>محتوای صوتی یافت نشد.</p>
        </div>
    }
</div>
