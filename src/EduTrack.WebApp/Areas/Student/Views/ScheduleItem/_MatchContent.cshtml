@model object
@using EduTrack.Application.Common.Models.ScheduleItems
@using EduTrack.Domain.Enums
@{
    var content = Model as MatchingContent;
    var scheduleItemId = ViewBag.ScheduleItemId as int? ?? 0;
}

<div class="matching-content-container">
    @if (content != null)
    {
        var blocks = content.Blocks;
        if (blocks != null && blocks.Any())
        {
            var blockIndex = 0;
            foreach (var block in blocks.OrderBy(b => b.Order))
            {
                ViewBag.BlockIndex = blockIndex;
                ViewBag.ScheduleItemType = ScheduleItemType.Match;
                ViewBag.ScheduleItemId = scheduleItemId;
                @await Html.PartialAsync("_MatchingBlock", block)
                blockIndex++;
            }
        }
        else if ((content.LeftItems?.Any() ?? false) && (content.RightItems?.Any() ?? false))
        {
            var fallbackItems = new List<MatchingBlockItem>();
            var connections = content.Connections?.Any() == true
                ? content.Connections
                : content.LeftItems
                    .OrderBy(li => li.Index)
                    .Select(li => new MatchingConnection
                    {
                        LeftIndex = li.Index,
                        RightIndex = li.Index
                    })
                    .ToList();

            foreach (var connection in connections)
            {
                var left = content.LeftItems.FirstOrDefault(li => li.Index == connection.LeftIndex);
                var right = content.RightItems.FirstOrDefault(ri => ri.Index == connection.RightIndex);
                if (left == null || right == null)
                {
                    continue;
                }

                fallbackItems.Add(new MatchingBlockItem
                {
                    Id = $"legacy-{connection.LeftIndex}",
                    Left = new MatchingBlockSide
                    {
                        Type = "text",
                        Text = left.Text
                    },
                    Right = new MatchingBlockSide
                    {
                        Type = "text",
                        Text = right.Text
                    }
                });
            }

            if (fallbackItems.Any())
            {
                var fallbackBlock = new MatchingBlock
                {
                    Id = "legacy",
                    Order = 0,
                    Points = Math.Max(1, fallbackItems.Count),
                    IsRequired = true,
                    Items = fallbackItems
                };

                ViewBag.BlockIndex = 0;
                ViewBag.ScheduleItemType = ScheduleItemType.Match;
                ViewBag.ScheduleItemId = scheduleItemId;
                @await Html.PartialAsync("_MatchingBlock", fallbackBlock)
            }
            else
            {
                <div class="content-empty-state">
                    <i class="fas fa-info-circle"></i>
                    <p>محتوای تطبیقی یافت نشد.</p>
                </div>
            }
        }
        else
        {
            <div class="content-empty-state">
                <i class="fas fa-info-circle"></i>
                <p>محتوای تطبیقی یافت نشد.</p>
            </div>
        }
    }
    else
    {
        <div class="content-empty-state">
            <i class="fas fa-info-circle"></i>
            <p>محتوای تطبیقی یافت نشد.</p>
        </div>
    }
</div>