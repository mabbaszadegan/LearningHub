@using EduTrack.Application.Common.Models.ScheduleItems
@using EduTrack.Domain.Enums
@using System.Linq
@model MultipleChoiceBlock
@{
    var scheduleItemId = ViewBag.ScheduleItemId as int? ?? 0;
    var blockIndex = ViewBag.BlockIndex as int? ?? 0;
    var scheduleItemType = ViewBag.ScheduleItemType as ScheduleItemType? ?? ScheduleItemType.MultipleChoice;
}

@{
    // Randomize options if needed
    var options = Model.RandomizeOptions 
        ? Model.Options.OrderBy(_ => Guid.NewGuid()).ToList() 
        : Model.Options.OrderBy(o => o.Index).ToList();
}

<div class="mcq-block-card" data-block-id="@Model.Id" data-block-order="@Model.Order">
    <div class="mcq-block-header">
        <div class="mcq-block-number" aria-label="سوال چندگزینه‌ای شماره @(blockIndex + 1)">
            <i class="fas fa-list-check" aria-hidden="true"></i>
            <span class="block-number-text">@((blockIndex + 1).ToString())</span>
            <span class="sr-only">سوال چندگزینه‌ای</span>
        </div>
        @if (!string.IsNullOrWhiteSpace(Model.Question))
        {
            <div class="mcq-question-minimal">
                <p>@Model.Question</p>
            </div>
        }
    </div>
    @if (!string.IsNullOrEmpty(Model.StemMediaType))
    {
        <div class="mcq-stem-media">
            @if (Model.StemMediaType == "image" && !string.IsNullOrEmpty(Model.StemImageUrl))
            {
                <div class="mcq-stem-image">
                    <img src="@Model.StemImageUrl" alt="@(Model.StemImageFileName ?? "تصویر")" class="mcq-stem-media-image">
                </div>
            }
            else if (Model.StemMediaType == "audio" && !string.IsNullOrEmpty(Model.StemAudioUrl))
            {
                <div class="mcq-stem-audio">
                    <audio controls class="mcq-stem-media-audio">
                        <source src="@Model.StemAudioUrl" type="audio/mpeg">
                    </audio>
                </div>
            }
            else if (Model.StemMediaType == "video" && !string.IsNullOrEmpty(Model.StemVideoUrl))
            {
                <div class="mcq-stem-video">
                    <video controls class="mcq-stem-media-video">
                        <source src="@Model.StemVideoUrl" type="video/mp4">
                    </video>
                </div>
            }
        </div>
    }
    <div class="mcq-block-content">
        <div class="mcq-options" data-answer-type="@Model.AnswerType" data-block-id="@Model.Id">
            @foreach (var option in options)
            {
                <div class="mcq-option" data-index="@option.Index">
                    <label class="mcq-option-label">
                        <input type="@(Model.AnswerType == "multiple" ? "checkbox" : "radio")" 
                               name="mcq-answer-@Model.Id" 
                               value="@option.Index"
                               class="mcq-option-input">
                        <span class="mcq-option-text">
                            @if (option.OptionType == "text")
                            {
                                <span>@option.Text</span>
                            }
                            else if (option.OptionType == "image" && !string.IsNullOrEmpty(option.ImageUrl))
                            {
                                <img src="@option.ImageUrl" alt="@option.Text" class="mcq-option-image">
                            }
                            else if (option.OptionType == "audio" && !string.IsNullOrEmpty(option.AudioUrl))
                            {
                                <div class="mcq-audio-option">
                                    <audio controls>
                                        <source src="@option.AudioUrl" type="audio/mpeg">
                                    </audio>
                                    @if (!string.IsNullOrEmpty(option.Text))
                                    {
                                        <span>@option.Text</span>
                                    }
                                </div>
                            }
                        </span>
                    </label>
                </div>
            }
        </div>
    </div>
    <div class="mcq-block-actions">
        <div class="block-actions-row">
            <button type="button" 
                    class="btn-check-answer-minimal" 
                    data-schedule-item-id="@scheduleItemId"
                    data-schedule-item-type="@scheduleItemType"
                    data-block-id="@Model.Id"
                    data-block-order="@Model.Order"
                    title="بررسی پاسخ">
                <i class="fas fa-check"></i>
            </button>
            <div class="block-answer-history" data-block-id="@Model.Id">
                <span class="history-correct" data-count="0">0</span>
                <span class="history-separator">/</span>
                <span class="history-incorrect" data-count="0">0</span>
            </div>
        </div>
    </div>
</div>



