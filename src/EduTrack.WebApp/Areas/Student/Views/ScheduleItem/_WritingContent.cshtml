@model object
@using EduTrack.Application.Common.Models.ScheduleItems
@using EduTrack.Domain.Enums
@using System.Linq
@{
    var content = Model as WritingContent;
}

<div class="writing-content-container">
    @if (content != null)
    {
        <!-- Combined Blocks and Question Blocks (sorted by Order) -->
        var allBlocks = new List<dynamic>();

        // Add content blocks
        if (content.Blocks != null && content.Blocks.Any())
        {
            foreach (var block in content.Blocks)
            {
                allBlocks.Add(new { Type = "content", Block = (object)block, Order = block.Order });
            }
        }

        // Add question blocks
        if (content.QuestionBlocks != null && content.QuestionBlocks.Any())
        {
            foreach (var questionBlock in content.QuestionBlocks)
            {
                allBlocks.Add(new { Type = "question", Block = (object)questionBlock, Order = questionBlock.Order });
            }
        }

        // Add multiple choice blocks
        if (content.MultipleChoiceBlocks != null && content.MultipleChoiceBlocks.Any())
        {
            foreach (var mcqBlock in content.MultipleChoiceBlocks)
            {
                allBlocks.Add(new { Type = "multiplechoice", Block = (object)mcqBlock, Order = mcqBlock.Order });
            }
        }

        // Sort by Order
        var sortedBlocks = allBlocks.OrderBy(b => b.Order).ToList();

        @if (sortedBlocks.Any())
        {
            <div class="content-blocks-wrapper">
                @{
                    var mcqBlockIndex = 0;
                }
                @foreach (var item in sortedBlocks)
                {
                    var blockType = item.Type;
                    var order = item.Order;

                    @if (blockType == "content")
                    {
                        var block = item.Block as ContentBlock;
                        if (block != null)
                        {
                            <div class="content-block content-block-@block.Type.ToString().ToLower()"
                                 data-block-order="@order"
                                 data-block-id="@block.Id"
                                 data-block-type="content">
                                <div class="content-block-inner">
                                    @await Html.PartialAsync("_ContentBlock", block)
                                </div>
                            </div>
                        }
                    }
                    else if (blockType == "question")
                    {
                        var questionBlock = item.Block as ReminderQuestionBlock;
                        if (questionBlock != null)
                        {
                            <div class="content-block content-block-question"
                                 data-block-order="@order"
                                 data-block-id="@questionBlock.Id"
                                 data-block-type="question">
                                <div class="content-block-inner">
                                    @await Html.PartialAsync("_QuestionBlock", questionBlock)
                                </div>
                            </div>
                        }
                    }
                    else if (blockType == "multiplechoice")
                    {
                        var mcqBlock = item.Block as MultipleChoiceBlock;
                        if (mcqBlock != null)
                        {
                            <div class="content-block content-block-multiplechoice"
                                 data-block-order="@order"
                                 data-block-id="@mcqBlock.Id"
                                 data-block-type="multiplechoice">
                                <div class="content-block-inner">
                                    @{
                                        var scheduleItemId = ViewBag.ScheduleItemId as int? ?? 0;
                                        ViewBag.BlockIndex = mcqBlockIndex;
                                        ViewBag.ScheduleItemType = ScheduleItemType.Writing;
                                        ViewBag.ScheduleItemId = scheduleItemId;
                                    }
                                    @await Html.PartialAsync("_MultipleChoiceBlock", mcqBlock)
                                </div>
                            </div>
                            mcqBlockIndex++;
                        }
                    }
                }
            </div>
        }
        
        <!-- Fallback: Show prompt if no blocks but prompt exists -->
        @if (!sortedBlocks.Any() && !string.IsNullOrEmpty(content.Prompt))
        {
            <div class="writing-prompt">
                <h4>متن سوال:</h4>
                <p>@content.Prompt</p>
            </div>
            
            @if (!string.IsNullOrEmpty(content.Instructions))
            {
                <div class="writing-instructions">
                    <h5>دستورالعمل‌ها:</h5>
                    <p>@content.Instructions</p>
                </div>
            }
        }
        
        <!-- Answer area (show if there are question blocks) -->
        @if (content.QuestionBlocks != null && content.QuestionBlocks.Any())
        {
            var wordLimit = content.WordLimit;
            
            <div class="writing-answer-area">
                <div class="form-group">
                    <label for="writing-answer">پاسخ خود را بنویسید:</label>
                    <textarea id="writing-answer" 
                              class="form-control" 
                              rows="10" 
                              placeholder="پاسخ خود را اینجا بنویسید..."
                              maxlength="@(wordLimit > 0 ? wordLimit * 10 : 10000)"></textarea>
                    @if (wordLimit > 0)
                    {
                        <div class="word-count">
                            <span id="word-count">0</span> / <span>@wordLimit</span> کلمه
                        </div>
                    }
                </div>
            </div>
            
            <div class="writing-actions">
                <button type="button" class="btn btn-primary" id="save-writing-answer">
                    <i class="fas fa-save"></i> ذخیره پاسخ
                </button>
                <button type="button" class="btn btn-success" id="submit-writing-answer">
                    <i class="fas fa-paper-plane"></i> ارسال پاسخ
                </button>
            </div>
        }
    }
    else
    {
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            محتوای نوشتاری یافت نشد.
            <p style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">
                Model type: @(Model?.GetType().Name ?? "null")
            </p>
        </div>
    }
</div>

