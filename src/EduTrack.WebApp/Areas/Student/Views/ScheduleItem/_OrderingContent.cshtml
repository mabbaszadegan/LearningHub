@model object
@using EduTrack.Application.Common.Models.ScheduleItems
@using System.Linq
@{
    var content = Model as OrderingContent;
}

<div class="ordering-content-container">
    @if (content != null)
    {
        // Check if we have multiple blocks or legacy single block
        var hasMultipleBlocks = content.Blocks != null && content.Blocks.Any();
        
        if (hasMultipleBlocks)
        {
            // Display all ordering blocks
            var blockIndex = 0;
            @foreach (var orderingBlock in content.Blocks!.OrderBy(b => b.Order))
            {
                // Parse direction to handle both old and new formats
                var finalDirection = "vertical-right"; // default
                if (orderingBlock.Direction != null)
                {
                    var dirLower = orderingBlock.Direction.ToLower();
                    // Check for complete direction values first
                    if (dirLower == "horizontal-ltr" || dirLower == "horizontal-rtl" ||
                        dirLower == "vertical-left" || dirLower == "vertical-right")
                    {
                        finalDirection = dirLower;
                    }
                    else if (dirLower == "horizontal")
                    {
                        // Legacy: default to horizontal-ltr
                        finalDirection = "horizontal-ltr";
                    }
                    else if (dirLower == "vertical")
                    {
                        // Legacy: use alignment if exists
                        var alignment = orderingBlock.Alignment ?? "right";
                        finalDirection = "vertical-" + alignment;
                    }
                    else
                    {
                        // Fallback: use alignment for vertical, default to right
                        var alignment = orderingBlock.Alignment ?? "right";
                        finalDirection = "vertical-" + alignment;
                    }
                }
                else
                {
                    // No direction set, use alignment or default
                    var alignment = orderingBlock.Alignment ?? "right";
                    finalDirection = "vertical-" + alignment;
                }

                var includedCount = orderingBlock.Items.Count(i => i.Include);
                var allItems = orderingBlock.Items.OrderBy(_ => Guid.NewGuid()).ToList();

                <div class="ordering-block-card" data-block-id="@orderingBlock.Id" data-block-order="@orderingBlock.Order">
                    @if (!string.IsNullOrWhiteSpace(orderingBlock.Instruction))
                    {
                        <div class="ordering-block-header">
                            <div class="ordering-block-number">@(blockIndex + 1)</div>
                            <div class="ordering-instruction-minimal">
                                <p>@orderingBlock.Instruction</p>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="ordering-block-header">
                            <div class="ordering-block-number">@(blockIndex + 1)</div>
                        </div>
                    }
                    <div class="ordering-block-content">
                        <div class="sorting-block" data-direction="@finalDirection" data-allow-dnd="@orderingBlock.AllowDragDrop.ToString().ToLower()" data-show-numbers="@orderingBlock.ShowNumbers.ToString().ToLower()">
                        <div class="sorting-pool" aria-label="لیست آیتم‌ها" role="list">
                            @foreach (var item in allItems)
                            {
                                <div class="sorting-item" role="listitem" data-id="@item.Id" data-type="@item.Type" tabindex="0">
                                    <span class="sorting-grip" aria-hidden="true"><i class="fas fa-grip-vertical"></i></span>
                                    @if (string.Equals(item.Type, "text", System.StringComparison.OrdinalIgnoreCase))
                                    {
                                        <span class="sorting-text">@item.Value</span>
                                    }
                                    else if (string.Equals(item.Type, "image", System.StringComparison.OrdinalIgnoreCase))
                                    {
                                        <img class="sorting-image" src="@item.FileUrl" alt="" />
                                    }
                                    else if (string.Equals(item.Type, "audio", System.StringComparison.OrdinalIgnoreCase))
                                    {
                                        <audio class="sorting-audio" controls src="@item.FileUrl"></audio>
                                    }
                                </div>
                            }
                        </div>

                        <div class="sorting-slots @("slots-" + finalDirection)" aria-label="فضاهای خالی" role="list">
                            @for (var i = 0; i < includedCount; i++)
                            {
                                var numberLabel = orderingBlock.ShowNumbers ? (i + 1).ToString() : string.Empty;
                                <div class="sorting-slot" role="listitem" data-index="@i">
                                    @if (orderingBlock.ShowNumbers)
                                    {
                                        <span class="slot-number">@numberLabel</span>
                                    }
                                    <div class="slot-dropzone" aria-label="رها کردن آیتم"></div>
                                </div>
                            }
                        </div>
                        </div>
                    </div>
                </div>
                blockIndex++;
            }
        }
        else if (content.Items.Any())
        {
            // Legacy: single ordering block
            var direction = "vertical-right";
            if (content.Direction != null)
            {
                var dirLower = content.Direction.ToLower();
                if (dirLower == "horizontal-ltr" || dirLower == "horizontal-rtl" ||
                    dirLower == "vertical-left" || dirLower == "vertical-right")
                {
                    direction = dirLower;
                }
                else if (dirLower == "horizontal")
                {
                    direction = "horizontal-ltr";
                }
                else if (dirLower == "vertical")
                {
                    // Legacy: use default right alignment
                    direction = "vertical-right";
                }
            }

            var includedCount = content.Items.Count(i => i.Include);
            var allItems = content.Items.OrderBy(_ => Guid.NewGuid()).ToList();

            <div class="ordering-block-card">
                @if (!string.IsNullOrWhiteSpace(content.Instruction))
                {
                    <div class="ordering-block-header">
                        <div class="ordering-block-number">1</div>
                        <div class="ordering-instruction-minimal">
                            <p>@content.Instruction</p>
                        </div>
                    </div>
                }
                else
                {
                    <div class="ordering-block-header">
                        <div class="ordering-block-number">1</div>
                    </div>
                }
                <div class="ordering-block-content">
                    <div class="sorting-block" data-direction="@direction" data-allow-dnd="@content.AllowDragDrop.ToString().ToLower()" data-show-numbers="@content.ShowNumbers.ToString().ToLower()">
                        <div class="sorting-pool" id="sortingPool" aria-label="لیست آیتم‌ها" role="list">
                            @foreach (var item in allItems)
                            {
                                <div class="sorting-item" role="listitem" data-id="@item.Id" data-type="@item.Type" tabindex="0">
                                    <span class="sorting-grip" aria-hidden="true"><i class="fas fa-grip-vertical"></i></span>
                                    @if (string.Equals(item.Type, "text", System.StringComparison.OrdinalIgnoreCase))
                                    {
                                        <span class="sorting-text">@item.Value</span>
                                    }
                                    else if (string.Equals(item.Type, "image", System.StringComparison.OrdinalIgnoreCase))
                                    {
                                        <img class="sorting-image" src="@item.FileUrl" alt="" />
                                    }
                                    else if (string.Equals(item.Type, "audio", System.StringComparison.OrdinalIgnoreCase))
                                    {
                                        <audio class="sorting-audio" controls src="@item.FileUrl"></audio>
                                    }
                                </div>
                            }
                        </div>

                        <div class="sorting-slots @("slots-" + direction)" id="sortingSlots" aria-label="فضاهای خالی" role="list">
                            @for (var i = 0; i < includedCount; i++)
                            {
                                var numberLabel = content.ShowNumbers ? (i + 1).ToString() : string.Empty;
                                <div class="sorting-slot" role="listitem" data-index="@i">
                                    @if (content.ShowNumbers)
                                    {
                                        <span class="slot-number">@numberLabel</span>
                                    }
                                    <div class="slot-dropzone" aria-label="رها کردن آیتم"></div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="content-empty-state">
                <i class="fas fa-info-circle"></i>
                <p>محتوای مرتب‌سازی یافت نشد.</p>
            </div>
        }
    }
    else
    {
        <div class="content-empty-state">
            <i class="fas fa-info-circle"></i>
            <p>محتوای مرتب‌سازی یافت نشد.</p>
        </div>
    }
</div>


