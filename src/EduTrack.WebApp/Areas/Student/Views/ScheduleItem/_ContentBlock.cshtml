@using EduTrack.Application.Common.Models.ScheduleItems
@using EduTrack.Domain.Enums
@model ContentBlock

@switch (Model.Type)
{
    case ContentBlockType.Text:
        <div class="content-block-text">
            @* Display HTML content exactly as saved by teacher, without any modifications *@
            @if (!string.IsNullOrEmpty(Model.Data.Content))
            {
                @* Content is HTML from CKEditor - display as-is *@
                @Html.Raw(Model.Data.Content)
            }
            else if (!string.IsNullOrEmpty(Model.Data.TextContent))
            {
                @* TextContent is plain text - convert line breaks only if it's plain text *@
                @Html.Raw(Model.Data.TextContent.Replace("\n", "<br />"))
            }
        </div>
        break;
        
    case ContentBlockType.Image:
        @if (!string.IsNullOrEmpty(Model.Data.FileUrl) || !string.IsNullOrEmpty(Model.Data.FileId))
        {
            var imageUrl = !string.IsNullOrEmpty(Model.Data.FileUrl) 
                ? Model.Data.FileUrl 
                : $"/FileUpload/GetFile/{Model.Data.FileId}";
                
            var imageSize = Model.Data.Size ?? "medium";
            var imagePosition = Model.Data.Position ?? "center";
            var captionPosition = Model.Data.CaptionPosition ?? "bottom";
            var hasOverlayCaption = !string.IsNullOrEmpty(Model.Data.Caption) && captionPosition == "overlay";
            
            <div class="content-block-image-block">
                <div class="content-block-image position-@imagePosition">
                    @if (!hasOverlayCaption && captionPosition == "top" && !string.IsNullOrEmpty(Model.Data.Caption))
                    {
                        <div class="image-caption image-caption-top">@Model.Data.Caption</div>
                    }
                    <div class="image-wrapper">
                        <img src="@imageUrl" 
                             alt="@(Model.Data.Caption ?? "تصویر")" 
                             class="content-image content-image-@imageSize"
                             loading="lazy" />
                        @if (hasOverlayCaption)
                        {
                            <div class="image-caption image-caption-overlay">@Model.Data.Caption</div>
                        }
                    </div>
                    @if (!hasOverlayCaption && captionPosition == "bottom" && !string.IsNullOrEmpty(Model.Data.Caption))
                    {
                        <div class="image-caption image-caption-bottom">@Model.Data.Caption</div>
                    }
                </div>
            </div>
        }
        break;
        
    case ContentBlockType.Video:
        @if (!string.IsNullOrEmpty(Model.Data.FileUrl) || !string.IsNullOrEmpty(Model.Data.FileId))
        {
            var videoUrl = !string.IsNullOrEmpty(Model.Data.FileUrl) 
                ? Model.Data.FileUrl 
                : $"/FileUpload/GetFile/{Model.Data.FileId}";
                
            <div class="content-block-video">
                <video controls class="content-video content-video-@(Model.Data.Size ?? "medium")">
                    <source src="@videoUrl" type="@(Model.Data.MimeType ?? "video/mp4")">
                    مرورگر شما از پخش ویدیو پشتیبانی نمی‌کند.
                </video>
                @if (!string.IsNullOrEmpty(Model.Data.Caption))
                {
                    <div class="content-caption content-caption-@(Model.Data.CaptionPosition ?? "bottom")">
                        @Model.Data.Caption
                    </div>
                }
            </div>
        }
        break;
        
    case ContentBlockType.Audio:
        {
            // Get FileId as string (handle both string and integer)
            var fileIdStr = Model.Data.FileId?.ToString();
            var hasFileUrl = !string.IsNullOrWhiteSpace(Model.Data.FileUrl);
            var hasFileId = !string.IsNullOrWhiteSpace(fileIdStr);
            
            // Always show audio block, even if file is missing
            <div class="content-block-audio-minimal">
                @if (hasFileUrl || hasFileId)
                {
                    var audioUrl = hasFileUrl 
                        ? Model.Data.FileUrl 
                        : $"/FileUpload/GetFile/{fileIdStr}";
                        
                    <audio controls class="content-audio-minimal" preload="metadata">
                        <source src="@audioUrl" type="@(Model.Data.MimeType ?? "audio/mpeg")">
                        مرورگر شما از پخش صدا پشتیبانی نمی‌کند.
                    </audio>
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        فایل صوتی یافت نشد.
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(Model.Data.Caption))
                {
                    <div class="content-caption content-caption-bottom">
                        @Model.Data.Caption
                    </div>
                }
            </div>
        }
        break;
        
    case ContentBlockType.Code:
        <div class="content-block-code">
            @if (!string.IsNullOrEmpty(Model.Data.CodeTitle))
            {
                <div class="code-title">@Model.Data.CodeTitle</div>
            }
            <pre class="code-block"><code class="language-@(Model.Data.Language ?? "plaintext")">@Html.Raw(Html.Encode(Model.Data.CodeContent ?? ""))</code></pre>
        </div>
        break;
        
    default:
        <div class="content-block-unknown">
            <p>نوع بلاک پشتیبانی نمی‌شود: @Model.Type</p>
        </div>
        break;
}

