@model object
@using EduTrack.Application.Common.Models.ScheduleItems
@using EduTrack.Domain.Enums
@using System.Linq
@{
    var content = Model as ReminderContent;
    var scheduleItemId = ViewBag.ScheduleItemId as int? ?? 0;
}

<div id="reminder-content" class="reminder-content-container" data-view-mode="unified">
    @if (content != null)
    {
        <!-- Main Message -->
        @if (!string.IsNullOrEmpty(content.Message))
        {
            <div class="content-block content-block-message">
                <div class="content-block-inner">
                    <div class="content-block-text">
                        @Html.Raw(content.Message.Replace("\n", "<br />"))
                    </div>
                </div>
            </div>
        }

        <!-- Combined Blocks, Question Blocks, and Ordering Blocks (sorted by Order) -->
        {
            var allBlocks = new List<dynamic>();

            // Add content blocks
            if (content.Blocks != null && content.Blocks.Any())
            {
                foreach (var block in content.Blocks)
                {
                    allBlocks.Add(new { Type = "content", Block = (object)block, Order = block.Order });
                }
            }

            // Add question blocks
            if (content.QuestionBlocks != null && content.QuestionBlocks.Any())
            {
                foreach (var questionBlock in content.QuestionBlocks)
                {
                    allBlocks.Add(new { Type = "question", Block = (object)questionBlock, Order = questionBlock.Order });
                }
            }

            // Add ordering blocks
            if (content.OrderingBlocks != null && content.OrderingBlocks.Any())
            {
                foreach (var orderingBlock in content.OrderingBlocks)
                {
                    allBlocks.Add(new { Type = "ordering", Block = (object)orderingBlock, Order = orderingBlock.Order });
                }
            }

            // Add multiple choice blocks
            if (content.MultipleChoiceBlocks != null && content.MultipleChoiceBlocks.Any())
            {
                foreach (var mcqBlock in content.MultipleChoiceBlocks)
                {
                    allBlocks.Add(new { Type = "multiplechoice", Block = (object)mcqBlock, Order = mcqBlock.Order });
                }
            }

            // Sort by Order
            var sortedBlocks = allBlocks.OrderBy(b => b.Order).ToList();

        @if (sortedBlocks.Any())
        {
            <div class="content-blocks-wrapper">
                @{
                    var orderingBlockIndex = 0;
                    var mcqBlockIndex = 0;
                }
                @foreach (var item in sortedBlocks)
                {
                    var blockType = item.Type;
                    var order = item.Order;

                    @if (blockType == "content")
                    {
                        var block = item.Block as ContentBlock;
                        if (block != null)
                        {
                            <div class="content-block content-block-@block.Type.ToString().ToLower()"
                                 data-block-order="@order"
                                 data-block-id="@block.Id"
                                 data-block-type="content">
                                <div class="content-block-inner">
                                    @await Html.PartialAsync("_ContentBlock", block)
                                </div>
                            </div>
                        }
                    }
                    else if (blockType == "question")
                    {
                        var questionBlock = item.Block as ReminderQuestionBlock;
                        if (questionBlock != null)
                        {
                            <div class="content-block content-block-question"
                                 data-block-order="@order"
                                 data-block-id="@questionBlock.Id"
                                 data-block-type="question">
                                <div class="content-block-inner">
                                    @await Html.PartialAsync("_QuestionBlock", questionBlock)
                                </div>
                            </div>
                        }
                    }
                    else if (blockType == "ordering")
                    {
                        var orderingBlock = item.Block as OrderingBlock;
                        if (orderingBlock != null)
                        {
                            // Parse direction to handle both old and new formats
                            var finalDirection = "vertical-right"; // default
                            if (orderingBlock.Direction != null)
                            {
                                var dirLower = orderingBlock.Direction.ToLower();
                                // Check for complete direction values first
                                if (dirLower == "horizontal-ltr" || dirLower == "horizontal-rtl" ||
                                    dirLower == "vertical-left" || dirLower == "vertical-right")
                                {
                                    finalDirection = dirLower;
                                }
                                else if (dirLower == "horizontal")
                                {
                                    // Legacy: default to horizontal-ltr
                                    finalDirection = "horizontal-ltr";
                                }
                                else if (dirLower == "vertical")
                                {
                                    // Legacy: use alignment if exists
                                    var alignment = orderingBlock.Alignment ?? "right";
                                    finalDirection = "vertical-" + alignment;
                                }
                                else
                                {
                                    // Fallback: use alignment for vertical, default to right
                                    var alignment = orderingBlock.Alignment ?? "right";
                                    finalDirection = "vertical-" + alignment;
                                }
                            }
                            else
                            {
                                // No direction set, use alignment or default
                                var alignment = orderingBlock.Alignment ?? "right";
                                finalDirection = "vertical-" + alignment;
                            }

                            var includedCount = orderingBlock.Items.Count(i => i.Include);
                            var allItems = orderingBlock.Items.OrderBy(_ => Guid.NewGuid()).ToList();

                            <div class="ordering-block-card" data-block-id="@orderingBlock.Id" data-block-order="@orderingBlock.Order">
                                @if (!string.IsNullOrWhiteSpace(orderingBlock.Instruction))
                                {
                                    <div class="ordering-block-header">
                                        <div class="ordering-block-number" aria-label="بلاک مرتب‌سازی شماره @(orderingBlockIndex + 1)">
                                            <i class="fas fa-arrow-up-wide-short" aria-hidden="true"></i>
                                            <span class="block-number-text">@((orderingBlockIndex + 1).ToString())</span>
                                            <span class="sr-only">مرتب‌سازی</span>
                                        </div>
                                        <div class="ordering-instruction-minimal">
                                            <p>@orderingBlock.Instruction</p>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="ordering-block-header">
                                        <div class="ordering-block-number" aria-label="بلاک مرتب‌سازی شماره @(orderingBlockIndex + 1)">
                                            <i class="fas fa-arrow-up-wide-short" aria-hidden="true"></i>
                                            <span class="block-number-text">@((orderingBlockIndex + 1).ToString())</span>
                                            <span class="sr-only">مرتب‌سازی</span>
                                        </div>
                                    </div>
                                }
                                <div class="ordering-block-content">
                                    <div class="sorting-block" data-direction="@finalDirection" data-allow-dnd="@orderingBlock.AllowDragDrop.ToString().ToLower()" data-show-numbers="@orderingBlock.ShowNumbers.ToString().ToLower()">
                                    <div class="sorting-pool" aria-label="لیست آیتم‌ها" role="list">
                                        @foreach (var orderingItem in allItems)
                                        {
                                            <div class="sorting-item" role="listitem" data-id="@orderingItem.Id" data-type="@orderingItem.Type" tabindex="0">
                                                <span class="sorting-grip" aria-hidden="true"><i class="fas fa-grip-vertical"></i></span>
                                                @if (string.Equals(orderingItem.Type, "text", System.StringComparison.OrdinalIgnoreCase))
                                                {
                                                    <span class="sorting-text">@orderingItem.Value</span>
                                                }
                                                else if (string.Equals(orderingItem.Type, "image", System.StringComparison.OrdinalIgnoreCase))
                                                {
                                                    <img class="sorting-image" src="@orderingItem.FileUrl" alt="" />
                                                }
                                                else if (string.Equals(orderingItem.Type, "audio", System.StringComparison.OrdinalIgnoreCase))
                                                {
                                                    <audio class="sorting-audio" controls src="@orderingItem.FileUrl"></audio>
                                                }
                                            </div>
                                        }
                                    </div>

                                    <div class="sorting-slots @("slots-" + finalDirection)" aria-label="فضاهای خالی" role="list">
                                        @for (var i = 0; i < includedCount; i++)
                                        {
                                            var numberLabel = orderingBlock.ShowNumbers ? (i + 1).ToString() : string.Empty;
                                            <div class="sorting-slot" role="listitem" data-index="@i">
                                                @if (orderingBlock.ShowNumbers)
                                                {
                                                    <span class="slot-number">@numberLabel</span>
                                                }
                                                <div class="slot-dropzone" aria-label="رها کردن آیتم"></div>
                                            </div>
                                        }
                                    </div>
                                    </div>
                                </div>
                                <div class="ordering-block-actions">
                                    <div class="block-actions-row">
                                        <button type="button" 
                                                class="btn-check-answer-minimal" 
                                                data-schedule-item-id="@scheduleItemId"
                                                data-schedule-item-type="@ScheduleItemType.Ordering"
                                                data-block-id="@orderingBlock.Id"
                                                data-block-order="@orderingBlock.Order"
                                                title="بررسی پاسخ">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <div class="block-answer-history" data-block-id="@orderingBlock.Id">
                                            <span class="history-correct" data-count="0">0</span>
                                            <span class="history-separator">/</span>
                                            <span class="history-incorrect" data-count="0">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            orderingBlockIndex++;
                        }
                    }
                    else if (blockType == "multiplechoice")
                    {
                        var mcqBlock = item.Block as MultipleChoiceBlock;
                        if (mcqBlock != null)
                        {
                            <div class="content-block content-block-multiplechoice"
                                 data-block-order="@order"
                                 data-block-id="@mcqBlock.Id"
                                 data-block-type="multiplechoice">
                                <div class="content-block-inner">
                                    @{
                                        ViewBag.BlockIndex = mcqBlockIndex;
                                        ViewBag.ScheduleItemType = ScheduleItemType.Reminder;
                                        ViewBag.ScheduleItemId = scheduleItemId;
                                    }
                                    @await Html.PartialAsync("_MultipleChoiceBlock", mcqBlock)
                                </div>
                            </div>
                            mcqBlockIndex++;
                        }
                    }
                }
            </div>
        }
        else
        {
            <!-- Debug: Show if no blocks found -->
            <div class="content-empty-state">
                <i class="fas fa-info-circle"></i>
                <p>هیچ بلاک محتوایی یافت نشد.</p>
                <p style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">
                    Blocks: @(content.Blocks?.Count ?? 0), 
                    QuestionBlocks: @(content.QuestionBlocks?.Count ?? 0),
                    OrderingBlocks: @(content.OrderingBlocks?.Count ?? 0),
                    MultipleChoiceBlocks: @(content.MultipleChoiceBlocks?.Count ?? 0)
                </p>
            </div>
        }
        }
    }
    else
    {
        <div class="content-empty-state">
            <i class="fas fa-info-circle"></i>
            <p>محتوای یادآوری یافت نشد.</p>
            <p style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">
                Model type: @(Model?.GetType().Name ?? "null")
            </p>
        </div>
    }
</div>
