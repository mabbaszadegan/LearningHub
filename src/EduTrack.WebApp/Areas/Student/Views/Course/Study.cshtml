@using EduTrack.Application.Common.Models.Courses
@using EduTrack.Application.Common.Models.TeachingPlans
@using EduTrack.Application.Common.Helpers
@using EduTrack.Domain.Enums
@using EduTrack.WebApp.Areas.Student.Models
@model CourseDto
@{
    ViewData["Title"] = $"مطالعه: {Model.Title}";
    var chapters = ViewBag.Chapters as List<ChapterDto> ?? new List<ChapterDto>();
    var scheduleItems = ViewBag.ScheduleItems as List<ScheduleItemDto> ?? new List<ScheduleItemDto>();
    var scheduleItemsWithStats = ViewBag.ScheduleItemsWithStats as List<ScheduleItemWithStats> ?? new List<ScheduleItemWithStats>();
    var enrollment = ViewBag.Enrollment as EduTrack.Application.Features.CourseEnrollment.DTOs.CourseEnrollmentDto;
    
    // Calculate total study time and sessions count
    var totalStudyTimeSeconds = scheduleItemsWithStats.Sum(s => s.TotalStudyTimeSeconds);
    var totalSessionsCount = scheduleItemsWithStats.Sum(s => s.StudySessionsCount);

    var categoryKeys = new[] { "general", "personalized", "assignments" };
    var categories = new List<(string Key, string Label, int Count)>();
    foreach (var key in categoryKeys)
    {
        var count = scheduleItemsWithStats.Count(si => GetItemCategory(si.Item) == key);
        if (count > 0)
        {
            var label = GetCategoryLabel(key);
            if (!string.IsNullOrWhiteSpace(label))
            {
                categories.Add((key, label!, count));
            }
        }
    }
    var defaultCategory = categories.FirstOrDefault().Key;
}

@section Styles {
    <link rel="stylesheet" href="~/css/areas/student/course/study-page.css" asp-append-version="true" />
}

<!-- Study Page Container -->
<div class="study-page-container" data-course-id="@Model.Id">
    <!-- Header -->
    <header class="study-page-header">
        <div class="study-header-content">
            <!-- Mobile Hamburger Menu -->
            <button class="study-hamburger-btn" id="studyHamburgerBtn" aria-label="منو">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- Course Title -->
            <div class="study-header-title">
                <h1>@Model.Title</h1>
                <div class="study-header-stats-minimal">
                    <i class="fas fa-clock stat-icon-minimal"></i>
                    <span class="stat-mini-header">@FormatTime(totalStudyTimeSeconds)</span>
                </div>
            </div>
            
            <!-- Sort Control in Header -->
            <div class="study-header-sort">
                <select id="sortBy" class="study-sort-select-minimal">
                    <option value="startDate">زمان ایجاد</option>
                    <option value="studyTime">بیشترین زمان</option>
                    <option value="lastStudy" selected>آخرین مطالعه</option>
                    <option value="mandatory">اجباری</option>
                </select>
            </div>
            
            <!-- Back Button -->
            <a href="@Url.Action("Index", "Home", new { area = "Student" })" class="study-back-btn" aria-label="بازگشت">
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>
        
        <!-- Category Tabs in Header -->
        @if (categories.Any())
        {
            <div class="study-header-tabs">
                <div class="study-tab-list" role="tablist">
                    @for (var i = 0; i < categories.Count; i++)
                    {
                        var category = categories[i];
                        var isActive = category.Key == defaultCategory;
                        <button type="button"
                                class="study-tab@(isActive ? " active" : string.Empty)"
                                data-category="@category.Key"
                                role="tab"
                                aria-selected="@(isActive ? "true" : "false")"
                                aria-controls="studyItemsGrid"
                                tabindex="@(isActive ? "0" : "-1")">
                            <span>@category.Label</span>
                            <span class="study-tab-count">@category.Count</span>
                        </button>
                    }
                </div>
            </div>
        }
    </header>

    <!-- Main Content Area -->
    <div class="study-main-wrapper">
        <!-- Sidebar -->
        <aside class="study-sidebar" id="studySidebar">
            <div class="study-sidebar-header">
                <h3>مباحث</h3>
                <button class="study-sidebar-close" id="studySidebarClose" aria-label="بستن">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="study-sidebar-content">
                <!-- Chapters List -->
                <div class="study-chapters-list">
                    <button class="study-filter-item study-filter-item-all active" data-filter="all" data-type="chapter">
                        <i class="fas fa-list"></i>
                        <span>همه مباحث</span>
                    </button>
                    
                    @foreach (var chapter in chapters.OrderBy(c => c.Order))
                    {
                        <div class="study-chapter-item" data-chapter-id="@chapter.Id">
                            <button class="study-chapter-header" data-chapter-id="@chapter.Id">
                                <i class="fas fa-chevron-left study-chapter-icon"></i>
                                <span class="study-chapter-title">@chapter.Title</span>
                                <span class="study-chapter-count">@(chapter?.SubChapters?.Count ?? 0)</span>
                            </button>
                            
                            @if (chapter?.SubChapters != null && chapter.SubChapters.Any())
                            {
                                <div class="study-subchapters-list" data-chapter-id="@chapter.Id">
                                    @foreach (var subChapter in chapter.SubChapters.OrderBy(sc => sc.Order))
                                    {
                                        <button class="study-subchapter-item" 
                                                data-subchapter-id="@subChapter.Id" 
                                                data-chapter-id="@chapter.Id">
                                            <span>@subChapter.Title</span>
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </aside>
        
        <!-- Sidebar Overlay (Mobile) -->
        <div class="study-sidebar-overlay" id="studySidebarOverlay"></div>
        
        <!-- Main Content -->
        <main class="study-content">
            <!-- Items Grid -->
            <div class="study-items-grid" id="studyItemsGrid">
                @if (scheduleItems.Any())
                {
                    @foreach (var statItem in scheduleItemsWithStats)
                    {
                        var item = statItem.Item;
                        if (item == null) continue;
                        
                        var totalTime = statItem.TotalStudyTimeSeconds;
                        var sessionsCount = statItem.StudySessionsCount;
                        var lastStudyDate = statItem.LastStudyDate;
                        
                        var category = GetItemCategory(item);
                        if (string.IsNullOrWhiteSpace(category))
                        {
                            continue;
                        }
                        var isVisible = string.IsNullOrWhiteSpace(defaultCategory) || category == defaultCategory;
                        var itemClasses = $"study-item-card{(isVisible ? string.Empty : " hidden")}";
                        
                        <a href="@Url.Action("Study", "ScheduleItem", new { area = "Student", id = item.Id })" 
                           class="@itemClasses" 
                           data-item-id="@item.Id"
                           data-item-type="@item.Type.ToString()"
                           data-category="@category"
                           data-status="@GetItemStatus(item)"
                           data-subchapter-ids="@string.Join(",", item.SubChapterAssignments.Select(sa => sa.SubChapterId))"
                           data-study-time="@totalTime"
                           data-last-study="@(lastStudyDate.HasValue ? lastStudyDate.Value.ToUnixTimeSeconds() : 0)"
                           data-is-mandatory="@(item.IsMandatory ? 1 : 0)"
                           data-created-at="@item.CreatedAt.ToUnixTimeSeconds()">
                            @if (lastStudyDate.HasValue)
                            {
                                <div class="study-item-last-study-badge">
                                    <i class="fas fa-history"></i>
                                    <span>@FormatLastStudyDate(lastStudyDate.Value)</span>
                                </div>
                            }
                            <div class="study-item-icon" style="background-color: @GetItemTypeColor(item.Type)">
                                <i class="@GetItemTypeIcon(item.Type)"></i>
                            </div>
                            <div class="study-item-content">
                                <h4 class="study-item-title">@item.Title</h4>
                                <div class="study-item-meta">
                                    @{
                                        var firstSubChapter = item.SubChapterAssignments.FirstOrDefault();
                                        if (firstSubChapter != null)
                                        {
                                            <div class="study-item-chapter-info">
                                                @if (!string.IsNullOrWhiteSpace(firstSubChapter.ChapterTitle))
                                                {
                                                    <span class="chapter-name">@firstSubChapter.ChapterTitle</span>
                                                    <span class="chapter-separator">/</span>
                                                }
                                                <span class="subchapter-name">@firstSubChapter.SubChapterTitle</span>
                                            </div>
                                        }
                                    }
                                    <div class="study-item-stats">
                                        <div class="stat-item">
                                            <i class="fas fa-clock stat-icon-minimal"></i>
                                            <span class="stat-mini">@FormatTime(totalTime)</span>
                                        </div>
                                        <div class="stat-item">
                                            <i class="fas fa-book-open stat-icon-minimal"></i>
                                            <span class="stat-mini">@sessionsCount</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="study-item-arrow">
                                <i class="fas fa-arrow-left"></i>
                            </div>
                        </a>
                    }
                }
                else
                {
                    <div class="study-empty-state">
                        <i class="fas fa-book-open"></i>
                        <h3>آیتم آموزشی یافت نشد</h3>
                        <p>هنوز آیتم آموزشی برای این دوره تعریف نشده است</p>
                    </div>
                }
            </div>
        </main>
    </div>
</div>

@section Scripts {
    <script>
        window.studyPageConfig = {
            courseId: @Model.Id,
            scheduleItems: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(scheduleItems.Select(si => new {
                id = si.Id,
                type = si.Type.ToString(),
                title = si.Title,
                status = GetItemStatus(si),
                subChapterIds = si.SubChapterAssignments.Select(sa => sa.SubChapterId).ToList()
            }))),
            chapters: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(chapters.Select(c => new {
                id = c.Id,
                title = c.Title,
                subChapterIds = c.SubChapters?.Select(sc => sc.Id).ToList() ?? new List<int>()
            })))
        };
    </script>
    <script src="~/js/areas/student/course/study-page.js" asp-append-version="true"></script>
}

@functions {
    string GetItemStatus(ScheduleItemDto item)
    {
        if (item.Status == ScheduleItemStatus.Completed)
            return "completed";
        if (item.IsOverdue)
            return "overdue";
        if (item.IsUpcoming)
            return "upcoming";
        return "active";
    }
    
    string GetItemStatusClass(ScheduleItemDto item)
    {
        var status = GetItemStatus(item);
        return $"status-{status}";
    }
    
    string GetItemTypeIcon(ScheduleItemType type)
    {
        return type switch
        {
            ScheduleItemType.Reminder => "fas fa-bell",
            ScheduleItemType.Writing => "fas fa-pen",
            ScheduleItemType.Audio => "fas fa-microphone",
            ScheduleItemType.GapFill => "fas fa-edit",
            ScheduleItemType.MultipleChoice => "fas fa-list-ul",
            ScheduleItemType.Match => "fas fa-link",
            ScheduleItemType.ErrorFinding => "fas fa-search",
            ScheduleItemType.CodeExercise => "fas fa-code",
            ScheduleItemType.Quiz => "fas fa-question-circle",
            ScheduleItemType.Ordering => "fas fa-sort",
            _ => "fas fa-file"
        };
    }
    
    string GetItemTypeName(ScheduleItemType type)
    {
        return type switch
        {
            ScheduleItemType.Reminder => "یادآوری",
            ScheduleItemType.Writing => "نوشتاری",
            ScheduleItemType.Audio => "صوتی",
            ScheduleItemType.GapFill => "جای خالی",
            ScheduleItemType.MultipleChoice => "چند گزینه‌ای",
            ScheduleItemType.Match => "تطبیق",
            ScheduleItemType.ErrorFinding => "پیدا کردن خطا",
            ScheduleItemType.CodeExercise => "تمرین کد",
            ScheduleItemType.Quiz => "کوییز",
            ScheduleItemType.Ordering => "مرتب‌سازی",
            _ => "نامشخص"
        };
    }
    
    string GetItemTypeColor(ScheduleItemType type)
    {
        return type switch
        {
            ScheduleItemType.Reminder => "#3b82f6",      // آبی
            ScheduleItemType.Writing => "#10b981",       // سبز
            ScheduleItemType.Audio => "#8b5cf6",         // بنفش
            ScheduleItemType.GapFill => "#f59e0b",       // نارنجی
            ScheduleItemType.MultipleChoice => "#ef4444", // قرمز
            ScheduleItemType.Match => "#1e40af",         // آبی تیره
            ScheduleItemType.ErrorFinding => "#eab308",  // زرد
            ScheduleItemType.CodeExercise => "#374151",  // خاکستری تیره
            ScheduleItemType.Quiz => "#991b1b",          // قرمز تیره
            ScheduleItemType.Ordering => "#60a5fa",      // آبی روشن
            _ => "#6b7280"                               // خاکستری
        };
    }
    
    string GetItemCategory(ScheduleItemDto? item)
    {
        if (item == null)
        {
            return string.Empty;
        }

        if (item.SessionReportId.HasValue)
        {
            return "assignments";
        }

        if (item.TeachingPlanId.HasValue)
        {
            return "personalized";
        }

        if (item.CourseId.HasValue)
        {
            return "general";
        }

        return "general";
    }

    string? GetCategoryLabel(string categoryKey)
    {
        return categoryKey switch
        {
            "general" => "آیتم‌های عمومی",
            "personalized" => "آیتم‌های اختصاصی",
            "assignments" => "تکالیف",
            _ => null
        };
    }

    string FormatTime(int totalSeconds)
    {
        var hours = totalSeconds / 3600;
        var minutes = (totalSeconds % 3600) / 60;
        var seconds = totalSeconds % 60;
        
        if (hours > 0)
        {
            return $"{hours}:{minutes:D2}:{seconds:D2}";
        }
        else if (minutes > 0)
        {
            return $"{minutes}:{seconds:D2}";
        }
        else
        {
            return $"{seconds}ث";
        }
    }
    
    string FormatLastStudyDate(DateTimeOffset date)
    {
        // Convert both to UTC for accurate comparison
        var now = DateTimeOffset.UtcNow;
        var dateUtc = date.ToUniversalTime();
        var diff = now - dateUtc;
        
        // If date is in the future (shouldn't happen, but handle it)
        if (diff.TotalSeconds < 0)
        {
            return "همین الان";
        }
        
        // Less than 1 minute
        if (diff.TotalSeconds < 60)
        {
            return "همین الان";
        }
        // Less than 1 hour
        else if (diff.TotalMinutes < 60)
        {
            var minutes = (int)diff.TotalMinutes;
            return $"{minutes} دقیقه پیش";
        }
        // Less than 24 hours
        else if (diff.TotalHours < 24)
        {
            var hours = (int)diff.TotalHours;
            return $"{hours} ساعت پیش";
        }
        // Less than 7 days
        else if (diff.TotalDays < 7)
        {
            var days = (int)diff.TotalDays;
            return $"{days} روز پیش";
        }
        // Less than 30 days
        else if (diff.TotalDays < 30)
        {
            var weeks = (int)(diff.TotalDays / 7);
            return $"{weeks} هفته پیش";
        }
        // Less than 365 days
        else if (diff.TotalDays < 365)
        {
            var months = (int)(diff.TotalDays / 30);
            return $"{months} ماه پیش";
        }
        // More than 1 year
        else
        {
            var years = (int)(diff.TotalDays / 365);
            return $"{years} سال پیش";
        }
    }
}
