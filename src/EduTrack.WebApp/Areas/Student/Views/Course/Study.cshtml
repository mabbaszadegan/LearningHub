@using EduTrack.Application.Common.Models.Courses
@using EduTrack.Application.Common.Models.TeachingPlans
@using EduTrack.Domain.Enums
@model CourseDto
@{
    ViewData["Title"] = $"مطالعه: {Model.Title}";
    var chapters = ViewBag.Chapters as List<ChapterDto> ?? new List<ChapterDto>();
    var scheduleItems = ViewBag.ScheduleItems as List<ScheduleItemDto> ?? new List<ScheduleItemDto>();
    var enrollment = ViewBag.Enrollment as EduTrack.Application.Features.CourseEnrollment.DTOs.CourseEnrollmentDto;
}

@section Styles {
    <link rel="stylesheet" href="~/css/areas/student/course/study-page.css" asp-append-version="true" />
}

<!-- Study Page Container -->
<div class="study-page-container" data-course-id="@Model.Id">
    <!-- Header -->
    <header class="study-page-header">
        <div class="study-header-content">
            <!-- Mobile Hamburger Menu -->
            <button class="study-hamburger-btn" id="studyHamburgerBtn" aria-label="منو">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- Course Title -->
            <div class="study-header-title">
                <h1>@Model.Title</h1>
            </div>
            
            <!-- Back Button -->
            <a href="@Url.Action("Index", "Home", new { area = "Student" })" class="study-back-btn" aria-label="بازگشت">
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>
        
        <!-- Type Filter in Header -->
        @if (scheduleItems.Any())
        {
            <div class="study-header-filters">
                <div class="study-type-filter-header">
                    @{
                        var typeGroups = scheduleItems.GroupBy(si => si.Type).OrderBy(g => g.Key);
                    }
                    @foreach (var typeGroup in typeGroups)
                    {
                        <button class="study-type-filter-item-header" 
                                data-type="@typeGroup.Key.ToString()" 
                                data-count="@typeGroup.Count()">
                            <i class="@GetItemTypeIcon(typeGroup.Key)"></i>
                            <span>@GetItemTypeName(typeGroup.Key)</span>
                        </button>
                    }
                </div>
            </div>
        }
    </header>

    <!-- Main Content Area -->
    <div class="study-main-wrapper">
        <!-- Sidebar -->
        <aside class="study-sidebar" id="studySidebar">
            <div class="study-sidebar-header">
                <h3>مباحث</h3>
                <button class="study-sidebar-close" id="studySidebarClose" aria-label="بستن">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="study-sidebar-content">
                <!-- Chapters List -->
                <div class="study-chapters-list">
                    <button class="study-filter-item study-filter-item-all active" data-filter="all" data-type="chapter">
                        <i class="fas fa-list"></i>
                        <span>همه مباحث</span>
                    </button>
                    
                    @foreach (var chapter in chapters.OrderBy(c => c.Order))
                    {
                        <div class="study-chapter-item" data-chapter-id="@chapter.Id">
                            <button class="study-chapter-header" data-chapter-id="@chapter.Id">
                                <i class="fas fa-chevron-left study-chapter-icon"></i>
                                <span class="study-chapter-title">@chapter.Title</span>
                                <span class="study-chapter-count">@(chapter?.SubChapters?.Count ?? 0)</span>
                            </button>
                            
                            @if (chapter?.SubChapters != null && chapter.SubChapters.Any())
                            {
                                <div class="study-subchapters-list" data-chapter-id="@chapter.Id">
                                    @foreach (var subChapter in chapter.SubChapters.OrderBy(sc => sc.Order))
                                    {
                                        <button class="study-subchapter-item" 
                                                data-subchapter-id="@subChapter.Id" 
                                                data-chapter-id="@chapter.Id">
                                            <span>@subChapter.Title</span>
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </aside>
        
        <!-- Sidebar Overlay (Mobile) -->
        <div class="study-sidebar-overlay" id="studySidebarOverlay"></div>
        
        <!-- Main Content -->
        <main class="study-content">
            <!-- Items Grid -->
            <div class="study-items-grid" id="studyItemsGrid">
                @if (scheduleItems.Any())
                {
                    @foreach (var item in scheduleItems.OrderBy(si => si.StartDate))
                    {
                        <a href="@Url.Action("Study", "ScheduleItem", new { area = "Student", id = item.Id })" 
                           class="study-item-card" 
                           data-item-id="@item.Id"
                           data-item-type="@item.Type.ToString()"
                           data-status="@GetItemStatus(item)"
                           data-subchapter-ids="@string.Join(",", item.SubChapterAssignments.Select(sa => sa.SubChapterId))">
                            <div class="study-item-icon" style="background-color: @GetItemTypeColor(item.Type)">
                                <i class="@GetItemTypeIcon(item.Type)"></i>
                            </div>
                            <div class="study-item-content">
                                <h4 class="study-item-title">@item.Title</h4>
                                <div class="study-item-status">
                                    <span class="study-status-badge @GetItemStatusClass(item)">
                                        @item.StatusText
                                    </span>
                                </div>
                            </div>
                            <div class="study-item-arrow">
                                <i class="fas fa-arrow-left"></i>
                            </div>
                        </a>
                    }
                }
                else
                {
                    <div class="study-empty-state">
                        <i class="fas fa-book-open"></i>
                        <h3>آیتم آموزشی یافت نشد</h3>
                        <p>هنوز آیتم آموزشی برای این دوره تعریف نشده است</p>
                    </div>
                }
            </div>
        </main>
    </div>
</div>

@section Scripts {
    <script>
        window.studyPageConfig = {
            courseId: @Model.Id,
            scheduleItems: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(scheduleItems.Select(si => new {
                id = si.Id,
                type = si.Type.ToString(),
                title = si.Title,
                status = GetItemStatus(si),
                subChapterIds = si.SubChapterAssignments.Select(sa => sa.SubChapterId).ToList()
            }))),
            chapters: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(chapters.Select(c => new {
                id = c.Id,
                title = c.Title,
                subChapterIds = c.SubChapters?.Select(sc => sc.Id).ToList() ?? new List<int>()
            })))
        };
    </script>
    <script src="~/js/areas/student/course/study-page.js" asp-append-version="true"></script>
}

@functions {
    string GetItemStatus(ScheduleItemDto item)
    {
        if (item.Status == ScheduleItemStatus.Completed)
            return "completed";
        if (item.IsOverdue)
            return "overdue";
        if (item.IsUpcoming)
            return "upcoming";
        return "active";
    }
    
    string GetItemStatusClass(ScheduleItemDto item)
    {
        var status = GetItemStatus(item);
        return $"status-{status}";
    }
    
    string GetItemTypeIcon(ScheduleItemType type)
    {
        return type switch
        {
            ScheduleItemType.Reminder => "fas fa-bell",
            ScheduleItemType.Writing => "fas fa-pen",
            ScheduleItemType.Audio => "fas fa-microphone",
            ScheduleItemType.GapFill => "fas fa-edit",
            ScheduleItemType.MultipleChoice => "fas fa-list-ul",
            ScheduleItemType.Match => "fas fa-link",
            ScheduleItemType.ErrorFinding => "fas fa-search",
            ScheduleItemType.CodeExercise => "fas fa-code",
            ScheduleItemType.Quiz => "fas fa-question-circle",
            ScheduleItemType.Ordering => "fas fa-sort",
            _ => "fas fa-file"
        };
    }
    
    string GetItemTypeName(ScheduleItemType type)
    {
        return type switch
        {
            ScheduleItemType.Reminder => "یادآوری",
            ScheduleItemType.Writing => "نوشتاری",
            ScheduleItemType.Audio => "صوتی",
            ScheduleItemType.GapFill => "جای خالی",
            ScheduleItemType.MultipleChoice => "چند گزینه‌ای",
            ScheduleItemType.Match => "تطبیق",
            ScheduleItemType.ErrorFinding => "پیدا کردن خطا",
            ScheduleItemType.CodeExercise => "تمرین کد",
            ScheduleItemType.Quiz => "کوییز",
            ScheduleItemType.Ordering => "مرتب‌سازی",
            _ => "نامشخص"
        };
    }
    
    string GetItemTypeColor(ScheduleItemType type)
    {
        return type switch
        {
            ScheduleItemType.Reminder => "#3b82f6",      // آبی
            ScheduleItemType.Writing => "#10b981",       // سبز
            ScheduleItemType.Audio => "#8b5cf6",         // بنفش
            ScheduleItemType.GapFill => "#f59e0b",       // نارنجی
            ScheduleItemType.MultipleChoice => "#ef4444", // قرمز
            ScheduleItemType.Match => "#1e40af",         // آبی تیره
            ScheduleItemType.ErrorFinding => "#eab308",  // زرد
            ScheduleItemType.CodeExercise => "#374151",  // خاکستری تیره
            ScheduleItemType.Quiz => "#991b1b",          // قرمز تیره
            ScheduleItemType.Ordering => "#60a5fa",      // آبی روشن
            _ => "#6b7280"                               // خاکستری
        };
    }
}
