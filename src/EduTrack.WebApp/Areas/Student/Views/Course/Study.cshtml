@using EduTrack.Application.Common.Models.Courses
@model CourseDto
@{
    ViewData["Title"] = $"مطالعه: {Model.Title}";
}

@section Styles {
    <link rel="stylesheet" href="~/css/areas/student/course/study-page.css" asp-append-version="true" />
}

<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="study-breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a asp-area="Student" asp-controller="Home" asp-action="Index">
                <i class="fas fa-home me-1"></i>خانه
            </a>
        </li>
        <li class="breadcrumb-item">
            <a asp-action="Index">
                <i class="fas fa-book-open me-1"></i>دوره‌های من
            </a>
        </li>
        <li class="breadcrumb-item">
            <a asp-action="Details" asp-route-id="@Model.Id">
                <i class="fas fa-info-circle me-1"></i>@Model.Title
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            <i class="fas fa-play me-1"></i>مطالعه
        </li>
    </ol>
</nav>

<!-- Enhanced Page Header -->
<div class="study-page-header">
    <div class="study-header-content">
        <div class="study-header-info">
            <div class="course-title-section">
                <h1 class="study-course-title">@Model.Title</h1>
                <p class="study-course-subtitle">مطالعه دوره</p>
            </div>
            <div class="study-progress-summary">
                <div class="progress-circle">
                    <div class="progress-circle-inner">
                        <span class="progress-percentage">@(ViewBag.Enrollment?.ProgressPercentage ?? 0)%</span>
                    </div>
                </div>
                <div class="progress-text">
                    <span class="progress-label">پیشرفت دوره</span>
                    <span class="progress-detail">@(ViewBag.Enrollment?.ProgressPercentage ?? 0) درصد تکمیل شده</span>
                </div>
            </div>
        </div>
        <div class="study-header-actions">
            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-modern-secondary btn-sm">
                <i class="fas fa-info-circle me-1"></i>جزئیات دوره
            </a>
            <a asp-action="Index" class="btn btn-modern-primary btn-sm">
                <i class="fas fa-list me-1"></i>دوره‌های من
            </a>
        </div>
    </div>
</div>

<!-- Floating Navigation -->
<div class="floating-navigation">
    <div class="floating-nav-item" data-tooltip="جزئیات دوره">
        <a asp-action="Details" asp-route-id="@Model.Id">
            <i class="fas fa-info-circle"></i>
        </a>
    </div>
    <div class="floating-nav-item" data-tooltip="دوره‌های من">
        <a asp-action="Index">
            <i class="fas fa-list"></i>
        </a>
    </div>
    <div class="floating-nav-item" data-tooltip="خانه">
        <a asp-area="Student" asp-controller="Home" asp-action="Index">
            <i class="fas fa-home"></i>
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-3">
        <!-- Course Progress Sidebar -->
        <div class="course-progress-sidebar">
            <div class="card study-progress-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>پیشرفت دوره
                    </h5>
                </div>
                <div class="card-body">
                    <div class="progress-container">
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: @(ViewBag.Enrollment?.ProgressPercentage ?? 0)%" 
                                 aria-valuenow="@(ViewBag.Enrollment?.ProgressPercentage ?? 0)" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                @(ViewBag.Enrollment?.ProgressPercentage ?? 0)%
                            </div>
                        </div>
                        
                        <div class="progress-stats">
                            <div class="stat-item">
                                <i class="fas fa-calendar-alt stat-icon"></i>
                                <div class="stat-content">
                                    <span class="stat-label">تاریخ ثبت‌نام</span>
                                    <span class="stat-value">@(ViewBag.Enrollment?.EnrolledAt.ToString("yyyy/MM/dd") ?? "")</span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-clock stat-icon"></i>
                                <div class="stat-content">
                                    <span class="stat-label">آخرین بازدید</span>
                                    <span class="stat-value">@(ViewBag.Enrollment?.LastAccessedAt?.ToString("yyyy/MM/dd") ?? "هیچ‌گاه")</span>
                                </div>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-book-open stat-icon"></i>
                                <div class="stat-content">
                                    <span class="stat-label">تعداد دروس</span>
                                    <span class="stat-value">@Model.Modules.Sum(m => m.Lessons.Count) درس</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Course Navigation -->
            <div class="card mt-3 study-navigation-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>فهرست دوره
                    </h5>
                    <div class="navigation-summary">
                        <small class="text-muted">@Model.Modules.Count ماژول • @Model.Modules.Sum(m => m.Lessons.Count) درس</small>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="course-navigation">
                        @if (Model.Modules.Any())
                        {
                            @foreach (var module in Model.Modules.OrderBy(m => m.Order))
                            {
                                <div class="navigation-section">
                                    <div class="section-header" data-bs-toggle="collapse" data-bs-target="#module-@module.Id">
                                        <div class="section-header-content">
                                            <i class="fas fa-folder me-2"></i>
                                            <span class="section-title">@module.Title</span>
                                            <span class="section-count">@module.Lessons.Count درس</span>
                                        </div>
                                        <i class="fas fa-chevron-down section-toggle"></i>
                                    </div>
                                    <div class="collapse" id="module-@module.Id">
                                        <div class="section-content">
                                            @if (module.Lessons.Any())
                                            {
                                                @foreach (var lesson in module.Lessons.OrderBy(l => l.Order))
                                                {
                                                    <div class="lesson-item">
                                                        <a href="#" class="lesson-link" data-lesson-id="@lesson.Id">
                                                            <div class="lesson-icon">
                                                                <i class="fas fa-play-circle"></i>
                                                            </div>
                                                            <div class="lesson-content">
                                                                <span class="lesson-title">@lesson.Title</span>
                                                                <span class="lesson-meta">
                                                                    <i class="fas fa-clock me-1"></i>@lesson.DurationMinutes دقیقه
                                                                </span>
                                                            </div>
                                                            <div class="lesson-status">
                                                                <i class="fas fa-check-circle text-success"></i>
                                                            </div>
                                                        </a>
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="no-lessons">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <small class="text-muted">درسی در این ماژول وجود ندارد</small>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="no-content">
                                <i class="fas fa-book-open fa-2x text-muted mb-3"></i>
                                <p class="text-muted mb-0">محتوایی در این دوره وجود ندارد</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-9">
        <!-- Course Content Area -->
        <div class="course-content-area">
            <div class="card study-content-card">
                <div class="card-header">
                    <div class="content-header-info">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-book me-2"></i>محتوای دوره
                        </h5>
                        <div class="content-status">
                            <span class="status-indicator">
                                <i class="fas fa-circle text-success me-1"></i>
                                آماده برای مطالعه
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="course-content-placeholder" class="content-placeholder">
                        <div class="placeholder-icon">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <h4 class="placeholder-title">برای شروع مطالعه، یک درس را انتخاب کنید</h4>
                        <p class="placeholder-subtitle">از فهرست سمت راست، درس مورد نظر خود را انتخاب کنید</p>
                        <div class="placeholder-actions">
                            <button class="btn btn-modern-primary" onclick="expandFirstModule()">
                                <i class="fas fa-arrow-down me-2"></i>نمایش اولین ماژول
                            </button>
                        </div>
                    </div>
                    
                    <div id="course-content" class="lesson-content-container" style="display: none;">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Handle lesson clicks
            $('.lesson-link').on('click', function(e) {
                e.preventDefault();
                var lessonId = $(this).data('lesson-id');
                loadLessonContent(lessonId);
            });

            // Auto-expand first module
            $('.navigation-section').first().find('.collapse').addClass('show');
            
            // Initialize tooltips for floating navigation
            initializeFloatingNavigation();
            
            // Update last accessed time
            updateLastAccessed();
        });

        function expandFirstModule() {
            $('.navigation-section').first().find('.collapse').addClass('show');
            $('.navigation-section').first().find('.section-toggle').removeClass('fa-chevron-down').addClass('fa-chevron-up');
        }

        function loadLessonContent(lessonId) {
            // Hide placeholder and show content area
            $('#course-content-placeholder').hide();
            $('#course-content').show();

            // Update active lesson
            $('.lesson-link').removeClass('active');
            $(`.lesson-link[data-lesson-id="${lessonId}"]`).addClass('active');

            // Load lesson content (placeholder for now)
            $('#course-content').html(`
                <div class="lesson-content">
                    <div class="lesson-header">
                        <h4 class="lesson-title">درس ${lessonId}</h4>
                        <div class="lesson-meta">
                            <span class="lesson-duration">
                                <i class="fas fa-clock me-1"></i>30 دقیقه
                            </span>
                            <span class="lesson-status">
                                <i class="fas fa-check-circle text-success me-1"></i>تکمیل شده
                            </span>
                        </div>
                    </div>
                    <div class="lesson-body">
                        <p>محتوای درس در اینجا نمایش داده خواهد شد. این بخش شامل متن، تصاویر، ویدیوها و سایر محتوای آموزشی خواهد بود.</p>
                        <div class="lesson-resources">
                            <h6>منابع درس:</h6>
                            <ul>
                                <li>فایل PDF درس</li>
                                <li>ویدیو آموزشی</li>
                                <li>تمرینات عملی</li>
                            </ul>
                        </div>
                    </div>
                    <div class="lesson-actions">
                        <button class="btn btn-modern-primary" onclick="markLessonComplete(${lessonId})">
                            <i class="fas fa-check me-2"></i>تکمیل درس
                        </button>
                        <button class="btn btn-modern-secondary" onclick="goToNextLesson(${lessonId})">
                            <i class="fas fa-arrow-right me-2"></i>درس بعدی
                        </button>
                    </div>
                </div>
            `);

            // Update last accessed time
            updateLastAccessed();
        }

        function markLessonComplete(lessonId) {
            if (confirm('آیا این درس را تکمیل کرده‌اید؟')) {
                // Update progress (placeholder for now)
                var currentProgress = @(ViewBag.Enrollment?.ProgressPercentage ?? 0);
                var newProgress = Math.min(100, currentProgress + 10);
                
                // Update progress bar
                $('.progress-bar').css('width', newProgress + '%').attr('aria-valuenow', newProgress);
                $('.progress-bar').text(newProgress + '%');

                // Update course progress
                $.ajax({
                    url: '@Url.Action("UpdateProgress")',
                    type: 'POST',
                    data: { 
                        courseId: @Model.Id, 
                        progressPercentage: newProgress 
                    },
                    success: function(response) {
                        if (response.success) {
                            // Show success message
                            showToast('درس با موفقیت تکمیل شد!', 'success');
                            
                            // Update lesson status
                            $(`.lesson-link[data-lesson-id="${lessonId}"] .lesson-status i`).removeClass('fa-circle').addClass('fa-check-circle text-success');
                        }
                    },
                    error: function() {
                        showToast('خطا در به‌روزرسانی پیشرفت', 'error');
                    }
                });
            }
        }

        function goToNextLesson(currentLessonId) {
            // Find next lesson
            var currentLesson = $(`.lesson-link[data-lesson-id="${currentLessonId}"]`);
            var nextLesson = currentLesson.closest('.lesson-item').next('.lesson-item').find('.lesson-link');
            
            if (nextLesson.length > 0) {
                nextLesson.click();
            } else {
                showToast('این آخرین درس است', 'info');
            }
        }

        function updateLastAccessed() {
            // Update last accessed time (placeholder for now)
            var now = new Date();
            var formattedDate = now.toLocaleDateString('fa-IR');
            $('.stat-item:last-child .stat-value').text(formattedDate);
        }

        function initializeFloatingNavigation() {
            // Add tooltip functionality to floating navigation
            $('.floating-nav-item').each(function() {
                var tooltip = $(this).data('tooltip');
                $(this).attr('title', tooltip);
            });
        }

        function showToast(message, type) {
            // Simple toast notification (you can replace with a proper toast library)
            var alertClass = type === 'success' ? 'alert-success' : 
                           type === 'error' ? 'alert-danger' : 
                           type === 'info' ? 'alert-info' : 'alert-primary';
            var toast = $(`
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999;">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            $('body').append(toast);
            
            // Auto-remove after 3 seconds
            setTimeout(function() {
                toast.alert('close');
            }, 3000);
        }
    </script>
}
