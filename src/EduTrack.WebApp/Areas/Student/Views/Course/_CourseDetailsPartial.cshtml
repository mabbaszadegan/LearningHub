@using EduTrack.Application.Common.Models.Courses
@model CourseDto
@{
    var isEnrolled = ViewBag.IsEnrolled ?? false;
    var canEnroll = ViewBag.CanEnroll ?? false;
}

@functions {
    string GetScheduleItemTypeName(EduTrack.Domain.Enums.ScheduleItemType type)
    {
        return type switch
        {
            EduTrack.Domain.Enums.ScheduleItemType.Reminder => "یادآوری",
            EduTrack.Domain.Enums.ScheduleItemType.Writing => "نوشتاری",
            EduTrack.Domain.Enums.ScheduleItemType.Audio => "صوتی",
            EduTrack.Domain.Enums.ScheduleItemType.GapFill => "جای خالی",
            EduTrack.Domain.Enums.ScheduleItemType.MultipleChoice => "چندگزینه‌ای",
            EduTrack.Domain.Enums.ScheduleItemType.Match => "تطبیقی",
            EduTrack.Domain.Enums.ScheduleItemType.ErrorFinding => "پیدا کردن خطا",
            EduTrack.Domain.Enums.ScheduleItemType.CodeExercise => "کدنویسی",
            EduTrack.Domain.Enums.ScheduleItemType.Quiz => "کوئیز",
            _ => "نامشخص"
        };
    }
}

<div class="course-details-container course-details-modal">
    <!-- Minimal Course Header -->
    <div class="course-header-minimal">
        <div class="course-header-content-minimal">
            <div class="course-title-section">
                <h1 class="course-title-minimal">@Model.Title</h1>
                <div class="course-meta-minimal">
                    <span class="course-teacher-minimal">
                        <i class="fas fa-user"></i>
                        @Model.CreatedByName
                    </span>
                    <span class="course-date-minimal">
                        <i class="fas fa-calendar"></i>
                        @{
                            var persianDate = new System.Globalization.PersianCalendar();
                            var year = persianDate.GetYear(Model.CreatedAt.DateTime);
                            var month = persianDate.GetMonth(Model.CreatedAt.DateTime);
                            var day = persianDate.GetDayOfMonth(Model.CreatedAt.DateTime);
                        }
                        @year/@month.ToString("00")/@day.ToString("00")
                    </span>
                </div>
            </div>
            
            @if (canEnroll && Model.IsActive)
            {
                <div class="course-badge-minimal enrollment-badge">قابل ثبت‌نام</div>
            }
        </div>
        
        <!-- Compact Stats -->
        <div class="course-stats-compact">
            <div class="stat-compact">
                <i class="fas fa-layer-group"></i>
                <span>@Model.ChapterCount</span>
            </div>
            <div class="stat-compact">
                <i class="fas fa-play-circle"></i>
                <span>@Model.ModuleCount</span>
            </div>
            <div class="stat-compact">
                <i class="fas fa-users"></i>
                <span>@Model.StudentCount</span>
            </div>
            <div class="stat-compact">
                <i class="fas fa-bookmark"></i>
                <span>@Model.LessonCount</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Course Description - 3 Lines with Expand/Collapse -->
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <div class="course-description-section-minimal">
                    <div class="course-description-header-minimal" onclick="toggleDescriptionMinimal()">
                        <h3 class="course-description-title-minimal">درباره این دوره</h3>
                        <i class="fas fa-chevron-down course-description-toggle-minimal" id="descriptionToggleMinimal"></i>
                    </div>
                    <div class="course-description-content-minimal">
                        <div class="course-description-preview-minimal" id="descriptionPreviewMinimal">
                            @Model.Description
                        </div>
                        <div class="course-description-full-minimal" id="descriptionFullMinimal" style="display: none;">
                            @Model.Description
                        </div>
                    </div>
                </div>
            }
            <!-- Course Chapters -->
            @if (Model.Chapters != null && Model.Chapters.Any())
            {
                <div class="course-chapters">
                    <h3 class="course-chapters-title">
                        <i class="fas fa-list"></i>
                        مباحث دوره
                    </h3>
                    
                    @foreach (var chapter in Model.Chapters.OrderBy(c => c.Order))
                    {
                        <div class="chapter-item">
                            <div class="chapter-header">
                                <div class="chapter-title-section">
                                    <h4 class="chapter-title">
                                        <i class="fas fa-folder"></i>
                                        @chapter.Title
                                        <span class="chapter-subchapter-count">@(chapter.SubChapters?.Count ?? 0)</span>
                                    </h4>
                                    <!-- Minimal Schedule Item Stats in Header -->
                                    <div class="chapter-header-stats">
                                        @{
                                            var scheduleItemStats = chapter.SubChapters?
                                                .SelectMany(sc => sc.ScheduleItemStats)
                                                .GroupBy(kvp => kvp.Key)
                                                .ToDictionary(g => g.Key, g => g.Sum(kvp => kvp.Value)) ?? new Dictionary<EduTrack.Domain.Enums.ScheduleItemType, int>();
                                        }
                                        @foreach (var stat in scheduleItemStats.Where(s => s.Value > 0))
                                        {
                                            <span class="chapter-stat-minimal">
                                                @stat.Value @GetScheduleItemTypeName(stat.Key)
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="chapter-content">
                                @if (!string.IsNullOrEmpty(chapter.Description))
                                {
                                    <p class="mb-3">@chapter.Description</p>
                                }
                                
                                <!-- Sub-chapters -->
                                @if (chapter.SubChapters != null && chapter.SubChapters.Any())
                                {
                                    <div class="subchapter-list">
                                        @foreach (var subChapter in chapter.SubChapters.OrderBy(sc => sc.Order))
                                        {
                                            <div class="subchapter-item">
                                                <h5 class="subchapter-title">@subChapter.Title</h5>
                                                @if (!string.IsNullOrEmpty(subChapter.Description))
                                                {
                                                    <p class="subchapter-description">@subChapter.Description</p>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="col-lg-4">
            <!-- Progress Section -->
            @if (isEnrolled)
            {
                <div class="progress-section">
                    <h3 class="progress-title">
                        <i class="fas fa-chart-line"></i>
                        پیشرفت شما
                    </h3>
                    
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" 
                             style="width: @(ViewBag.Enrollment?.ProgressPercentage ?? 0)%"
                             data-width="@(ViewBag.Enrollment?.ProgressPercentage ?? 0)%">
                        </div>
                    </div>
                    
                    <div class="progress-stats">
                        <div class="progress-stat">
                            <div class="progress-stat-number">@(ViewBag.Enrollment?.ProgressPercentage ?? 0)%</div>
                            <div class="progress-stat-label">پیشرفت</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-stat-number">@(ViewBag.Enrollment?.EnrolledAt.ToString("yyyy/MM/dd") ?? "")</div>
                            <div class="progress-stat-label">تاریخ ثبت‌نام</div>
                        </div>
                        <div class="progress-stat">
                            <div class="progress-stat-number">@(ViewBag.Enrollment?.LastAccessedAt?.ToString("yyyy/MM/dd") ?? "هیچ‌گاه")</div>
                            <div class="progress-stat-label">آخرین بازدید</div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Course Footer with Actions - Modal Version -->
<div class="course-footer-modal">
    <div class="course-footer-actions-modal">
        @if (isEnrolled)
        {
            <button type="button" class="course-footer-btn-minimal btn-study-minimal" 
                    onclick="window.location.href='@Url.Action("Study", new { id = Model.Id })'"
                    title="شروع مطالعه">
                <i class="fas fa-play"></i>
            </button>
            <button type="button" class="course-footer-btn-minimal btn-unenroll-minimal" 
                    data-action="unenroll" data-course-id="@Model.Id"
                    title="خروج از دوره">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        }
        else if (canEnroll && Model.IsActive)
        {
            <button type="button" class="course-footer-btn-minimal btn-enroll-minimal" 
                    data-action="enroll" data-course-id="@Model.Id"
                    title="ثبت‌نام در دوره">
                <i class="fas fa-plus"></i>
            </button>
        }
        else if (!Model.IsActive)
        {
            <button type="button" class="course-footer-btn-minimal btn-secondary-minimal" disabled
                    title="دوره غیرفعال">
                <i class="fas fa-lock"></i>
            </button>
        }
        else
        {
            <button type="button" class="course-footer-btn-minimal btn-secondary-minimal" disabled
                    title="غیرقابل ثبت‌نام">
                <i class="fas fa-ban"></i>
            </button>
        }
        
        <button type="button" class="course-footer-btn-minimal btn-close-minimal" 
                onclick="bootstrap.Modal.getInstance(document.getElementById('courseDetailsModal')).hide()"
                title="بستن">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>
