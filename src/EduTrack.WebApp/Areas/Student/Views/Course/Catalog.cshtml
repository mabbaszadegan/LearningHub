@using EduTrack.Application.Common.Models.Courses
@model EduTrack.Application.Common.Models.PaginatedList<StudentCourseCatalogDto>
@{
    ViewData["Title"] = "کاتالوگ دوره‌ها";
    Layout = "~/Areas/Student/Views/Shared/_StudentLayout.cshtml";
}

<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2>کاتالوگ دوره‌ها</h2>
            <p>دوره‌های موجود برای ثبت‌نام</p>
        </div>
        <div>
            <a asp-action="Index" class="btn btn-sm">
                <i class="fas fa-list me-1"></i>دوره‌های من
            </a>
        </div>
    </div>
</div>

<!-- Course List Container -->
<div class="course-list-container">

    @if (Model.Items.Any())
    {
        <div class="row">
            @foreach (var course in Model.Items)
            {
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="course-card" data-course-id="@course.Id">
                        <div class="course-thumbnail">
                            @if (!string.IsNullOrEmpty(course.Thumbnail))
                            {
                                <img src="@course.Thumbnail" alt="@course.Title" class="img-fluid">
                            }
                            else
                            {
                                <div class="course-thumbnail-placeholder">
                                    <i class="fas fa-book"></i>
                                    <span>دوره آموزشی</span>
                                </div>
                            }
                            <div class="course-status">
                                @if (course.IsActive)
                                {
                                    <span class="badge bg-success">فعال</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">غیرفعال</span>
                                }
                            </div>
                        </div>
                        <div class="course-content">
                            <h5 class="course-title">@course.Title</h5>
                            @if (!string.IsNullOrEmpty(course.Description))
                            {
                                <p class="course-description">@course.Description</p>
                            }
                            
                            <!-- Comprehensive Course Statistics -->
                            <div class="course-stats">
                                <div class="row text-center">
                                    <div class="col-6 mb-2">
                                        <div class="stat-item">
                                            <div class="stat-number">@course.ChapterCount</div>
                                            <div class="stat-label">مبحث</div>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <div class="stat-item">
                                            <div class="stat-number">@course.SubChapterCount</div>
                                            <div class="stat-label">زیرمبحث</div>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <div class="stat-item">
                                            <div class="stat-number">@course.EducationalContentCount</div>
                                            <div class="stat-label">محتوا</div>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <div class="stat-item">
                                            <div class="stat-number">@course.ExamCount</div>
                                            <div class="stat-label">آزمون</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Information -->
                            <div class="course-meta">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <small class="text-muted">
                                            <i class="fas fa-layer-group me-1"></i>
                                            @course.ModuleCount ماژول
                                        </small>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">
                                            <i class="fas fa-play-circle me-1"></i>
                                            @course.LessonCount درس
                                        </small>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted">
                                            <i class="fas fa-users me-1"></i>
                                            @course.ClassCount کلاس
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <div class="course-actions">
                                <a asp-action="Details" asp-route-id="@course.Id" class="btn btn-modern-primary btn-sm w-100 mb-2">
                                    <i class="fas fa-info-circle"></i>مشاهده جزئیات
                                </a>
                                @if (course.IsEnrolled)
                                {
                                    <button type="button" class="btn btn-modern-success btn-sm w-100" disabled>
                                        <i class="fas fa-check"></i>ثبت‌نام شده
                                    </button>
                                }
                                else if (course.CanEnroll)
                                {
                                    <button type="button" class="btn btn-modern-success btn-sm w-100" 
                                            data-action="enroll" data-course-id="@course.Id">
                                        <i class="fas fa-plus"></i>ثبت‌نام در دوره
                                    </button>
                                }
                                else
                                {
                                    <button type="button" class="btn btn-modern-secondary btn-sm w-100" disabled>
                                        <i class="fas fa-lock"></i>دوره غیرفعال
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

    <!-- Pagination -->
    @if (Model.TotalPages > 1)
    {
        <nav aria-label="صفحه‌بندی دوره‌ها">
            <ul class="pagination justify-content-center">
                @if (Model.HasPreviousPage)
                {
                    <li class="page-item">
                        <a class="page-link" asp-action="Catalog" asp-route-pageNumber="@(Model.PageNumber - 1)">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                }

                @for (int i = Math.Max(1, Model.PageNumber - 2); i <= Math.Min(Model.TotalPages, Model.PageNumber + 2); i++)
                {
                    <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                        <a class="page-link" asp-action="Catalog" asp-route-pageNumber="@i">@i</a>
                    </li>
                }

                @if (Model.HasNextPage)
                {
                    <li class="page-item">
                        <a class="page-link" asp-action="Catalog" asp-route-pageNumber="@(Model.PageNumber + 1)">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                }
            </ul>
        </nav>
    }
}
    else
    {
        <div class="text-center py-5">
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h4>دوره‌ای یافت نشد</h4>
                <p>در حال حاضر دوره‌ای برای ثبت‌نام موجود نیست</p>
                <a asp-action="Index" class="btn btn-modern-primary">
                    <i class="fas fa-list me-2"></i>بازگشت به دوره‌های من
                </a>
            </div>
        </div>
    }
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/areas/student/course-list.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/areas/student/course-list.js" asp-append-version="true"></script>
    <script>
        // Course enrollment functionality
        document.addEventListener('click', (e) => {
            if (e.target.closest('[data-action="enroll"]')) {
                e.preventDefault();
                const courseId = e.target.closest('[data-action="enroll"]').dataset.courseId;
                enrollInCourse(courseId);
            }
        });

        function enrollInCourse(courseId) {
            if (confirm('آیا مطمئن هستید که می‌خواهید در این دوره ثبت‌نام کنید؟')) {
                const button = document.querySelector(`[data-action="enroll"][data-course-id="${courseId}"]`);
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>در حال ثبت‌نام...';
                }

                fetch('@Url.Action("Enroll")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `courseId=${courseId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (button) {
                            button.innerHTML = '<i class="fas fa-check"></i>ثبت‌نام شده';
                            button.classList.remove('btn-modern-success');
                            button.classList.add('btn-modern-secondary');
                        }
                        // Show success message
                        showToast(data.message, 'success');
                    } else {
                        if (button) {
                            button.disabled = false;
                            button.innerHTML = '<i class="fas fa-plus"></i>ثبت‌نام در دوره';
                        }
                        showToast(data.error || 'خطا در ثبت‌نام', 'error');
                    }
                })
                .catch(error => {
                    console.error('Enrollment error:', error);
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-plus"></i>ثبت‌نام در دوره';
                    }
                    showToast('خطا در ارتباط با سرور', 'error');
                });
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;

            Object.assign(toast.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                background: type === 'success' ? '#28a745' : '#dc3545',
                color: 'white',
                padding: '12px 20px',
                borderRadius: '8px',
                boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
                zIndex: '9999',
                transform: 'translateX(100%)',
                transition: 'transform 0.3s ease',
                maxWidth: '300px',
                fontSize: '14px',
                fontWeight: '500'
            });

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
    </script>
}